WeakRef and FinalizationRegistry
================================

<img class="icon" src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **언어 내 숨겨진 기능**

- 굉장히 드물게 사용

<br />

##### 도달 가능 원칙 <sub>(가비지 컬렉션)</sub>
- 도달 가능한 · 사용중인 값
```javaScript
// user (변수)
// - 객체 참조
let user = { name: "John" };

// user (변수)
// - null 할당
user = null;

// 객체 참조 없어짐
// - 메모리에서 객체 삭제
```
- 참조 2개
```javaScript
// user (변수)
// - 객체 참조
let user = { name: "John" };

// 참조 값 복사
// - user (변수) → admin (변수)
let admin = user;

// user (변수)
// - null 할당
user = null;

// 객체
// - 도달 가능 · 참조 유지 (admin 변수)
//   - 메모리에 객체 유지
```

<img class="icon" src="../../images/commons/icons/circle-exclamation-solid.svg" /> **용어 : "강한 참조" · "약한 참조"**

##### 강한 참조
- 가비지 컬렉션 작동 대상 X
  - 참조 메모리 위치에 객체 · 값 저장
- JS
  - 일반적인 객체 참조
```javaScript
// user (변수)
// - 강한 참조
let user = { name: "John" };
```

##### 약한 참조
- 가비지 컬렉션 작동 대상
- 약한 참조만 존재 시
  - 메모리에서 삭제

### `WeakRef`

<img class="icon" src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **주의**

##### 이번 학습에서 사용하는 구조
- 신중한 사용 필요
- 되도록 사용 지양

<br />

##### 어떤 객체에 대한 약한 참조 저장 객체
- 어떤 객체
  - "타겟"
  - "지시 대상"

##### 특징
- "타겟" · "지시 대상" 객체
  - 가비지 컬렉터 작동 대상

##### 예제
- `user` <sub>(변수)</sub>
  - 지시 대상
- `admin` <sub>(변수)</sub>
  - `user` <sub>(변수)</sub> 에 대한 약한 참조
- `WeakRef` 생성자
  - 타겟 <sub>(지시 대상)</sub> 객체 인수 전달
```javaScript
// user (변수)
// - 객체에 대한 강한 참조
let user = { name: "John" };

// admin (변수)
// - 객체에 대한 약한 참조
let admin = new WeakRef(user);
```
- `user` <sub>(변수)</sub>
  - 강한 참조
- `admin` <sub>(변수)</sub>
  - 약한 참조

![9weakref-finalizationregistry-01](../../images/01/14/07/weakref-finalizationregistry-01.svg)

##### 어느 순간
- `user` <sub>(변수)</sub> 사용 X
  - 값 덮어씌우기
  - 스코프 밖으로 이동
  - 기타 등등 등
- `admin` <sub>(변수)</sub>
  - 약한 참조 유지
```javaScript
// user (변수)
// - null 값 할당
user = null;
```
- 객체에 대한 약한 참조
  - 객체 유지 불가능
- 약한 참조만 존재 시
  - 가비지 컬렉터 작동

##### 가비지 컬렉터 작동 전
- 약한 참조 유지 가능
  - 강한 참조 부재 상태
- 객체 상태
  - 슈뢰딩거의 고양이
  - 전혀 알 수 없음

![9weakref-finalizationregistry-02](../../images/01/14/07/weakref-finalizationregistry-02.svg)

##### `deref()` <sub>(메서드)</sub>
- 객체 삭제 전
  - `WeakRef` 참조 객체 반환
- 객체 삭제 후
  - `undefined` 반환
```javaScript
let ref = admin.deref();

if (ref) {

  // 객체 아직 삭제 X
  // - 객체 대상 작업 가능

} else {

  // 객체 삭제 완료
  // - 가비지 컬렉터에 의해 제거됨

}
```

### `WeakRef` 유스 케이스

##### 일반적인 사용처
- 캐싱
- 연관 배열
  - 자원 집중적인 객체 저장

##### 기능
- 캐시 · 연관 배열 내 객체 존재 시
  - 가비지 컬렉터 작동하게끔 함

##### ex&#41; 수많은 이진 이미지 객체들
- `ArrayBuffer` · `Blob` 등
- 각 파일별로 이름 · 경로 설정
- 기존 자료구조
  - 사용 부적합
- `Map`
  - 객체 저장
  - 메모리 사용량 ↑
- `WeakMap`
  - 약한 참조 사용
  - 가비지 컬렉터 작동
- 약한 참조 사용 자료구조
  - 사용 적합

##### `Map` 컬렉션
- 값 : `WeakRef` 인스턴스
  - 용량 큰 객체 약한 참조
    - 오랫동안 저장 X
- '도달 가능한' 상태일 경우
  - 캐시에서 이미지 객체 얻기
  - 캐시에서 삭제되었을 경우
    - 재생성 · 재다운로드
- 메모리 사용량 절약
### 유스 케이스 1 : 캐싱