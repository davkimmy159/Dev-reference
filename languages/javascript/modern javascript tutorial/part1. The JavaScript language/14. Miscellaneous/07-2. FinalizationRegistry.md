`FinalizationRegistry` <sub>(객체)</sub>
====

##### `FinalizationRegistry` <sub>(특수 객체)</sub>
- 객체 · 청소 콜백 내부 등록 후 연결
  - 등록 객체 메모리 내 제거 시
    - 청소 콜백 자동 호출

##### 용도
- 가비지 컬렉션 작동 후 추가 동작 수행

##### 객체 생성
- 청소 콜백 전달 필요
```javascript
// heldValue (콜백 인수)
// - 객체 전달 시 강한 참조 유지
function cleanupCallback(heldValue) {
  …청소 콜백 코드…
}

const registry = new FinalizationRegistry(cleanupCallback);
```

### 메서드

#### `register`

##### 추적 객체 등록
```javascript
register(target, heldValue[, unregisterToken])
```

##### `target` <sub>(객체)</sub>
- 등록 객체 <sub>(이후 추적)</sub>
  - 약한 참조 유지
  - 강한 참조 시 가비지 컬렉션 작동 대상 X
- 메모리 내 제거 시 청소 콜백 자동 호출
  - `heldValue` 전달

##### `[unregisterToken]`
- 제거 토큰
- 가비지 컬렉션 작동 전 등록 객체 제거 시 사용
- 보통 `target` <sub>(객체)</sub> 사용 <sub>(관행)</sub>

#### `unregister`

##### 등록 객체 제거
```javascript
unregister(unregisterToken)
```
- `unregisterToken`
  - 객체 등록 시 설정 값

#### 객체 생성 후 `user` <sub>(객체)</sub> · 청소 콜백 등록
```javascript
let user = {name: "John"};

// 객체 생성 · 청소 콜백 등록
const registry = new FinalizationRegistry((heldValue) => {
  console.log(`${heldValue}: 메모리 내 제거 완료.`);
});

// 추적 객체 등록
// - user (객체) 메모리 내 제거 시 user.name 콜백 전달
registry.register(user, user.name);
```
- 메모리 내 `user` <sub>(객체)</sub> 제거 시
  - 청소 콜백 실행 <sub>(콘솔 메시지 출력)</sub>
```javascript
"John: 메모리 내 제거 완료."
```

##### 청소 콜백 미호출 가능성 有
- a.프로그램 완전 종료
  - 브라우저 탭 닫기
  - 기타 등등
- b. `FinalizationRegistry` <sub>(객체)</sub> 도달 불가
  - 생성 객체 유실 · 제거 시
    - 청소 콜백 호출 X

### 캐싱

##### `WeakRef` <sub>(객체)</sub> 캐싱 예제
- 캐시 <sub>(`Map` 객체)</sub> 내 메모리 누수 발생
  - 값 <sub>(`WeakRef` 객체)</sub> 제거 시
    - 키 계속 유지
- `FinalizationRegistry` <sub>(객체)</sub> 적용
  - 약한 참조 객체 제거 시 해당 요소 제거
```javascript
function fetchImg() {
  …이미지 다운로드…
}

function weakRefCache(fetchImg) {
  const imgCache = new Map();

  // ①
  // FinalizationRegistry (객체) 생성
  // - WeakRef (객체) 참조 객체 (이미지) 제거 시 해당 요소 제거
  const registry = new FinalizationRegistry((imgName) => {
    const cachedImg = imgCache.get(imgName);

    if (cachedImg && !cachedImg.deref()) {
      imgCache.delete(imgName);
    }
  });

  return (imgName) => {
    const cachedImg = imgCache.get(imgName);

    if (cachedImg?.deref()) {
      return cachedImg?.deref();
    }

    const newImg = fetchImg(imgName);

    imgCache.set(imgName, new WeakRef(newImg));

    // ②
    // 이미지 다운로드 · 캐시 내 삽입 후
    // - FinalizationRegistry (객체) 내 등록 (추적)
    registry.register(newImg, imgName);

    return newImg;
  };
}

const getCachedImg = weakRefCache(fetchImg);
```

##### 캐시 내 `WeakRef` <sub>(객체)</sub> 참조 유지 요소만 유지
- 메모리 내 약한 참조 객체 <sub>(이미지)</sub> 제거 시
  - 청소 콜백 실행 <sub>(캐시 내 해당 요소 제거)</sub>

![9weakref-finalizationregistry-05](../../images/01/14/07/weakref-finalizationregistry-05.svg)

#### 특징

##### 주요 코드 · 청소 콜백 사이 병렬 작업 허용
- 두 작업 사이 시차 有
  - 객체 삭제 표시 <sub>(가비지 컬렉터)</sub> 시점
  - 실제 청소 콜백 실행 시점
- 시차 내 추적 객체 대상 모든 작업 가능
  - 메모리 내 다시 로드
  - 기타 등등

That’s why, in the cleanup callback, we must check to see if an entry has been added back to the cache by the main program to avoid deleting “live” entries. Similarly, when searching for a key in the cache, there is a chance that the value has been deleted by the garbage collector, but the cleanup callback has not been executed yet.

##### 추가 확인 작업 필수
- a. 캐시 내 `WeakRef` <sub>(객체)</sub> 참조 객체 재추가 여부
- b. 

##### 특별 상황 <sub>(주의)</sub>
- 키 검색 도중 가비지 컬렉터 의해 제거
  - 청소 콜백 실행 전

### 실무 <sub>(`WeakRef` · `FinalizationRegistry`)</sub>

##### 실무 시나리오
- 모바일 · 클라우드 사진 동기화
  - 타 기기에서 사진 보기
  - 기타 추가 기능 제공

##### 추가 기능들
- 사진 편집 · 영상 효과
- 임시 저장 · 앨범 생성
- 일련 사진 → 영상 몽타주 <sub>(변환)</sub>
- 기타 등등

##### 예제

![weakref-finalizationregistry-demo-01](../../images/01/14/07/weakref-finalizationregistry-demo-01.png)

##### 좌측
- 클라우드 사진 라이브러리
  - 섬네일 목록 <sub>(사진 표시)</sub>

##### 우측
- "Create collage" 버튼
  - 사진 선택 · 콜라주 생성 <sub>(다운로드 가능)</sub>

##### 압축
- 사진 다운로드 · 표시 섬네일
  - 페이지 로딩 속도 ↑

##### 압축 X
- 사진 선택 · 콜라주 생성

![weakref-finalizationregistry-demo-02](../../images/01/14/07/weakref-finalizationregistry-demo-02.png)

##### 크기
- 섬네일 고유 크기
  - 240 x 240 <sub>(픽셀)</sub>
- 미리보기 모드
  - 전체 크기 불필요

##### 콜라주 생성 <sub>(사진 4장)</sub>
1. 사진 선택
2. "Create collage" 버튼 클릭
3. `weakRefCache` <sub>(함수)</sub>
    - 캐시 내 이미지 유무 여부 확인
    - 부재 시
      - 다운로드 <sub>(클라우드)</sub>
      - 캐시 삽입

### 실무 : `WeakRef` <sub>(객체)</sub> · `FinalizationRegistry`

##### 실무 시나리오
- 모바일 · 클라우드 사진 동기화
  - 타 기기에서 사진 보기
  - 기타 추가 기능 제공

##### 추가 기능들
- 사진 편집 · 영상 효과
- 임시 저장 · 앨범 생성
- 일련 사진 → 영상 몽타주 변환
- 기타 등등

#### 예제

##### 좌측
- 클라우드 사진 라이브러리
  - 섬네일로 사진 표시

##### 우측
- "Create collage" 버튼
  - 사진 선택 · 콜라주 생성
    - 다운로드 가능

##### 압축 적용
- 사진 다운로드 · 섬네일
  - 페이지 로딩 속도 ↑

##### 압축 미적용
- 사진 선택 · 콜라주 생성

![weakref-finalizationregistry-demo-01](../../images/01/14/07/weakref-finalizationregistry-demo-01.png)

##### 크기
- 섬네일 고유 크기
  - 240 x 240 <sub>(픽셀)</sub>
- 미리보기 모드
  - 전체 크기 불필요

![weakref-finalizationregistry-demo-02](../../images/01/14/07/weakref-finalizationregistry-demo-02.png)

##### 콜라주 생성 <sub>(사진 4장)</sub>
1. 사진 선택
2. "Create collage" 버튼 클릭
3. `weakRefCache` <sub>(함수)</sub>
    - 캐시 내 이미지 유무 여부 확인
    - 부재 시
      1. 클라우드에서 다운로드
      2. 캐시 내 삽입
    - 각 선택 사진 대상 동작

![weakref-finalizationregistry-demo-03](../../images/01/14/07/weakref-finalizationregistry-demo-03.gif)

##### 콘솔 화면
- 클라우드에서 다운로드된 사진 확인
  - _'FETCHED_IMAGE'_

##### 첫 콜라주 생성
- 캐시 내 이미지 無
  1. 모든 사진 다운로드
  2. 캐시 내 삽입

##### 이미지 다운로드 중
- 가비지 컬렉터 의해 메모리 청소 <sub>(동시 진행)</sub>

##### 캐시 내 이미지 <sub>(약한 참조)</sub>
- 가비지 컬렉터 의해 제거
- 청소 콜백 <sub>(함수)</sub>
  - 캐시 내 빈 요소 <sub>(키만 남음)</sub> 제거
    - _'CLEANED_IMAGE'_

![weakref-finalizationregistry-demo-04](../../images/01/14/07/weakref-finalizationregistry-demo-04.jpg)

##### 사진 교체 후 새 콜라주 생성
1. 교체할 사진 선택 해제
2. 다른 사진 선택
3. "Create collage" 버튼 클릭

![weakref-finalizationregistry-demo-05](../../images/01/14/07/weakref-finalizationregistry-demo-05.gif)

##### 다운로드
- 모든 이미지 X
  - 캐시 내 부재 이미지
- 일부 이미지
  - 캐시에서 가져옴
    - _'CACHED_IMAGE'_

##### 새 콜라주 생성 시점
- 가비지 컬렉터 의해 이미지 제거 전
- 네트워크 요청 수 ↓
  - 작업 처리 속도 ↑

![weakref-finalizationregistry-demo-06](../../images/01/14/07/weakref-finalizationregistry-demo-06.jpg)

##### 이미지 1개 교체 후 다시 새 콜라주 생성

![weakref-finalizationregistry-demo-07](../../images/01/14/07/weakref-finalizationregistry-demo-07.gif)

##### 총 선택 사진 수 : 4개
- 3개
  - 캐시에서 가져옴
- 1개
  - 클라우드에서 다운로드
- 네크워크 로드 감소량
  - 75%

![weakref-finalizationregistry-demo-08](../../images/01/14/07/weakref-finalizationregistry-demo-08.jpg)

##### 항상 동일 작동 보장 X
- 결과 항상 다름
  - 구현체 상이
  - 가비지 컬렉터 동작 메커니즘

##### 일반적인 경우 학습 내용 불필요
- `WeakRef` <sub>(객체)</sub>
- `FinalizationRegistry`

[예제](https://plnkr.co/edit/L7yYPNraR6ujk9ib?p=preview) <sub>(다른 구현 방식)</sub>

<br />

요약
====

##### `FinalizationRegistry`
- 청소 콜백 등록
- 객체 대상 강한 참조 부재 시
  - 콜백 호출 후 해당 콜백 자동 제거
- 용도
  - 객체 관련 자원 관리
  - 객체 제거 시 작업 관리
