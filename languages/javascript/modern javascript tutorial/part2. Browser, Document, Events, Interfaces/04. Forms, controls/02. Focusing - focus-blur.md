`focus` · `blur` <sub>(이벤트)</sub>
============

##### 요소 포커스 <sub>(`focus`)</sub>
- 폼 요소 클릭
- Tab 키 눌러 해당 폼 요소 이동
- `autofocus` <sub>(속성)</sub>
  - 페이지 로드 후 자동 포커스
- 기타 등등

##### 포커스 의미
- '여기에 데이터 입력할 준비하라'
- 요소 포커싱 순간
  - 요구사항 충족 초기화 코드 실행 가능

##### 요소 포커스 해제 <sub>(`blur`)</sub>
- 다른 폼 요소 클릭
- Tab 키 눌러 다음 폼 필드 이동
- 기타 등등

##### 포커스 해제 의미
- '데이터 입력 완료되었다'
- 포커싱 해제 순간
  - 데이터 체크
  - 서버 요청 전송 <sub>(데이터 저장)</sub>
  - 기타 등등

### `focus` · `blur` <sub>(이벤트)</sub>
- 요소 포커스 받을 · 잃을 때 발생

##### 입력 필드 값 검증
- `blur` 핸들러
  - 필드 내 입력 이메일 확인
  - 부정확한 입력 시
    - 에러 표시
- `focus` 핸들러
  - 에러 메시지 숨기기
  - 이메일 재확인
    - `blur` 핸들러
```html
<style>
  .invalid { border-color: red; }
  #error { color: red }
</style>

이메일: <input type="email" id="input">

<div id="error"></div>

<script>
input.onblur = function() {

  // 이메일 유효성 체크
  // - '@' 유무 여부
  if (!input.value.includes('@')) {
    input.classList.add('invalid');
    error.innerHTML = '올바른 이메일 주소를 입력하세요.'
  }
};

input.onfocus = function() {
  if (this.classList.contains('invalid')) {

    // 사용자 새 값 입력 위해 <input> (필드) 다시 선택
    // -  에러 메시지 제거
    this.classList.remove('invalid');
    error.innerHTML = "";
  }
};
</script>
```

![focus-blur-event](../../images/02/04/02/focus-blur-event.png)

##### 모던 HTML
- 다양한 속성 사용해 입력값 검증 가능
  - `required`
  - `pattern`
  - 기타 등등
- JS 사용 이유
  - 좀 더 유연
  - 추가 동작 가능
    - 입력값 자동 서버 전송
    - 기타 등등

### `focus` · `blur` <sub>(메서드)</sub>
- 요소 포커스 주기 · 제거

##### 사이트 방문자가 유효하지 않은 값을 입력하면 사이트를 떠나지 못하도록 하는 예시를 살펴봅시다.
```html
<style>
  .error {
    background: red;
  }
</style>

이메일: <input type="email" id="input">
<input type="text" style="width:220px" placeholder="이메일 형식이 아닌 값을 입력하고 여기에 포커스를 주세요.">

<script>
  input.onblur = function() {
    if (!this.value.includes('@')) { // 이메일이 아님
      // 에러 출력
      this.classList.add("error");
      // input 필드가 포커스 되도록 함
      input.focus();
    } else {
      this.classList.remove("error");
    }
  };
</script>
```

![focus-blur-method](../../images/02/04/02/focus-blur-method.png)

이 예시는 Firefox([bug](https://bugzilla.mozilla.org/show_bug.cgi?id=53579))를 제외한 모든 브라우저에서 정상 동작합니다.

이메일이 아닌 값을 입력하고 Tab 키나 다른 곳을 클릭해 `<input>`을 벗어나려 하면 `onblur` 메서드가 동작해 포커스를 다시 입력 필드로 돌려놓습니다.

여기서 주의해야 할 점은 `onblur`는 요소가 포커스를 잃고 난 후에 발생하기 때문에 `onblur` 안에서 `event.preventDefault()`를 호출해 포커스를 잃게 하는걸 '막을 수 없다'라는 사실입니다.

<br />

<img src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **JavaScript-initiated focus loss**

A focus loss can occur for many reasons.

One of them is when the visitor clicks somewhere else. But also JavaScript itself may cause it, for instance:

- An `alert` moves focus to itself, so it causes the focus loss at the element (`blur` event), and when the `alert` is dismissed, the focus comes back (`focus` event).
- If an element is removed from DOM, then it also causes the focus loss. If it is reinserted later, then the focus doesn't return.
These features sometimes cause `focus`/`blur` handlers to misbehave – to trigger when they are not needed.

The best recipe is to be careful when using these events. If we want to track user-initiated focus-loss, then we should avoid causing it ourselves.

<br />

### `tabindex`를 사용해서 모든 요소 포커스 하기
대다수의 요소는 기본적으로 포커싱을 지원하지 않습니다.

포커싱을 지원하지 않는 요소 목록은 브라우저마다 다르긴 하지만 한 가지 확실한 것은 `<button>`, `<input>`, `<select>`, `<a>`와 같이 사용자가 웹 페이지와 상호작용 할 수 있게 도와주는 요소는 `focus`, `blur`를 지원한다는 사실입니다.

반면 `<div>`, `<span>`, `<table>`같이 무언가를 표시하는 용도로 사용하는 요소들은 포커싱을 지원하지 않습니다. 따라서 이런 요소엔 `elem.focus()` 메서드가 동작하지 않고 `focus`, `blur`이벤트도 트리거 되지 않습니다.

그럼에도 불구하고 포커스를 하고 싶다면 `tabindex` HTML 속성을 사용하면 됩니다.

`tabindex` 속성이 있는 요소는 종류와 상관없이 포커스가 가능합니다. 속성값은 숫자인데, 이 숫자는 Tab 키를 눌러 요소 사이를 이동할 때 순서가 됩니다.

요소가 두 개 있다고 가정하고 첫 번째 요소의 `tabindex`엔 `1`을, 두 번째 요소의 `tabindex`엔 `2`를 할당하면 첫 번째 요소가 포커싱되어있는 상태에서 Tab을 눌렀을 때 두 번째 요소로 포커스가 이동합니다.

포커싱 되는 요소 순서는 다음과 같습니다. `tabindex`가 `1`인 요소부터 시작해 점점 큰 숫자가 매겨진 요소로 이동하고 그다음 `tabindex`가 없는 요소(평범한 `<input>` 요소 등)로 이동합니다.

`tabindex`가 없는 요소들은 문서 내 순서에 따라 포커스가 이동합니다(기본 순서).

그런데 `tabindex`를 사용할 땐 주의해야 할 사항이 있습니다.
- `tabindex`가 `0`인 요소 – 이 요소는 `tabindex` 속성이 없는것처럼 동작합니다. 따라서 포커스를 이동시킬 때 `tabindex`가 `0`인 요소는 `tabindex`가 `1`보다 크거나 같은 요소보다 나중에 포커스를 받습니다.

  `tabindex="0"`은 요소를 포커스 가능하게 만들지만 포커스 순서는 기본 순서 그대로 유지하고 싶을 때 사용합니다. 요소의 포커스 우선 순위를 일반 `<input>`과 같아지도록 하죠.
- `tabindex`가 `-1`인 요소 – 스크립트로만 포커스 하고 싶은 요소에 사용합니다. Tab키를 사용하면 이 요소는 무시되지만 `elem.focus()` 메서드를 사용하면 잘 포커싱 됩니다.

예시를 살펴봅시다. 첫 번째 항목을 클릭하고 Tab 키를 눌러보세요.
```html
첫 번째 항목을 클릭하고 Tab 키를 눌러보면서 포커스 된 요소 순서를 눈여겨보세요. 참고로 탭을 많이 누르면 예시 밖으로 포커스가 이동하니, 주의하세요.
<ul>
  <li tabindex="1">일</li>
  <li tabindex="0">영</li>
  <li tabindex="2">이</li>
  <li tabindex="-1">음수 일</li>
</ul>

<style>
  li { cursor: pointer; }
  :focus { outline: 1px dashed green; }
</style>
```

![tabindex-focusing-on-all-element](../../images/02/04/02/tabindex-focusing-on-all-element.png)

보시다시피 포커스는 `tabindex`가 `1`, `2`, `0`인 요소로 차례로 이동합니다. `<li>`는 기본적으로 포커스 할 수 없는 요소이지만 예시에서 `tabindex`를 사용해서 실제 포커스를 해보았고 포커스 된 요소는 `:focus`를 사용해서 스타일을 바꿔보았습니다.

<br />

<img src="../../images/commons/icons/circle-exclamation-solid.svg" /> **`elem.tabIndex` 프로퍼티를 사용해도 됩니다.**

자바스크립트를 사용해 `elem.tabIndex` 프로퍼티를 추가해주면 `tabindex` 속성을 사용한 것과 동일한 효과를 볼 수 있습니다.

<br />

### `focusin`과 `focusout`을 사용해 이벤트 위임하기
`focus`와 `blur` 이벤트는 버블링 되지 않습니다.

예시를 살펴봅시다. `<form>`에 `onfocus`를 추가해 강조 효과를 주려고 했는데, 의도한 대로 동작하지 않는 것을 확인할 수 있습니다.
```html
<!-- 폼 안에서 포커스가 된 경우 클래스를 추가함 -->
<form onfocus="this.className='focused'">
  <input type="text" name="surname" value="성">
  <input type="text" name="name" value="이름">
</form>

<style> .focused { outline: 1px solid red; } </style>
```

![focusin-focusout-event-delegation](../../images/02/04/02/focusin-focusout-event-delegation.png)

의도한 대로 예시가 동작하지 않는 이유는 사용자가 `<input>`을 포커스 해도 `focus` 이벤트는 해당 입력 필드에서만 트리거 되기 때문입니다. `focus` 이벤트는 버블링 되지 않습니다. 따라서 `form.onfocus`는 절대 트리거 되지 않습니다.

이런 기본동작을 피해 이벤트 위임 효과를 주는 방법은 두 가지가 있습니다.

첫 번째 방법은 `focus`와 `blur`는 버블링 되지 않지만 캡처링은 된다는 점을 이용하면 됩니다.

아래 예시를 직접 실행해봅시다.
```html
<form id="form">
  <input type="text" name="surname" value="성">
  <input type="text" name="name" value="이름">
</form>

<style> .focused { outline: 1px solid red; } </style>

<script>
  // 캡쳐링 단계에서 핸들러가 트리거되도록 합니다(마지막 인수가 true)
  form.addEventListener("focus", () => form.classList.add('focused'), true);
  form.addEventListener("blur", () => form.classList.remove('focused'), true);
</script>
```

![focusin-focusout-event-delegation](../../images/02/04/02/focusin-focusout-event-delegation.png)

두 번째 방법은 `focusin`과 `focusout`을 이용하는 것입니다. 두 이벤트는 `focus`, `blur`와 동일하지만 버블링이 된다는 점에서 차이가 있습니다.

`focusin`과 `focusout`을 사용할 때 주의할 점은 `on<event>` 방식으로 핸들러를 추가하면 안 되고 `elem.addEventListener` 방식으로 핸들러를 추가해야 한다는 점입니다.

예시를 실행해 실제 이벤트가 버블링 되는지 확인해봅시다.
```html
<form id="form">
  <input type="text" name="surname" value="성">
  <input type="text" name="name" value="이름">
</form>

<style> .focused { outline: 1px solid red; } </style>

<script>
  form.addEventListener("focusin", () => form.classList.add('focused'));
  form.addEventListener("focusout", () => form.classList.remove('focused'));
</script>
```

![focusin-focusout-event-delegation](../../images/02/04/02/focusin-focusout-event-delegation.png)

<br />

## 요약
`focus`와 `blur` 이벤트는 각각 요소가 포커스를 받을 때, 잃을 때 발생합니다.

두 이벤트를 사용할 땐 다음을 유의해야 합니다.
- `focus`와 `blur` 이벤트는 버블링 되지 않습니다. 캡처링이나 `focusin`, `focusout`을 사용하면 이벤트 위임 효과를 볼 수 있습니다.
- 대부분의 요소는 기본적으로 포커스를 지원하지 않습니다. 그럼에도 불구하고 포커스 하고 싶은 요소가 있다면 `tabindex`를 사용하면 됩니다.

현재 포커스된 요소는 `document.activeElement`를 통해 확인할 수 있습니다.

<br />

## <img src="../../images/commons/icons/circle-check-solid.svg" /> 과제

### 수정 가능한 `div`
중요도: 5
클릭하면 `<textarea>`로 변하는 `<div>`를 만들어보세요.

`textarea`에선 `<div>` 안에있는 HTML을 수정할 수 있어야 합니다.

사용자가 Enter를 누르거나 `textarea` 요소가 포커스를 잃으면 `<textarea>`는 다시 `<div>`로 변해야 하고 textarea에 입력했던 콘텐츠는 `<div>`안 HTML이 되어야 합니다.

<br />

<img src="../../images/commons/icons/circle-answer.svg" />

[샌드박스를 열어 정답을 확인해보세요.](https://plnkr.co/edit/pE9UdaOM7XbZMDGJ?p=preview)

<hr />

### 클릭해서 TD 수정하기
셀을 클릭하면 해당 셀을 수정할 수 있게 해주는 테이블을 만들어보세요.
- 셀 클릭 시 셀 안에 `textarea`가 나타나면서 셀에 들어 있는 콘텐츠(HTML)를 '수정'할 수 있어야 합니다. 이때 `textarea` 크기는 기존 `cell` 크기와 같아야 합니다.
- 셀 수정 시 셀 하단에 '완료'와 '취소' 버튼이 노출되도록 하고, 각 버튼을 누르면 수정이 종료, 취소될 수 있게 합니다.
- 한 번에 하나의 셀만 수정할 수 있어야 합니다. `<td>`가 '수정 중'일 때는 다른 셀을 눌러도 클릭 이벤트가 무시되어야 합니다.
- 테이블엔 더 많은 셀이 추가될 수 있으므로 이벤트 위임을 사용하세요.

데모:

![assignment-click-td-modifying](../../images/02/04/02/assignment-click-td-modifying.png)

<br />

<img src="../../images/commons/icons/circle-answer.svg" />

1. 셀 클릭 시 셀의 `innerHTML`을 `<textarea>`로 교체합니다. 이때 기존 `<textarea>`는 기존 셀의 크기와 같고, 테두리(border)가 없습니다. 크기 지정엔 자바스크립트를 사용해도 되고, CSS를 사용해도 됩니다.
2. `textarea.value`를 `td.innerHTML`과 같게 설정합니다.
3. `textarea`에 포커스를 줍니다.
4. 셀 아래에 완료, 취소 <sub>(버튼)</sub> 을 보여주고, 버튼에 적절한 핸들러를 달아줍니다.
샌드박스를 열어 정답을 확인해보세요.

<hr />

### 키보드로 쥐 움직이기
쥐에 포커스를 준 다음 화살표 키를 이용해서 쥐를 움직여봅시다.

[새 창에서 데모 보기](https://ko.js.cx/task/keyboard-mouse/solution/)

참고
1. `#mouse` 요소 이 외의 어느 곳에도 이벤트 핸들러를 달지 마세요.
2. HTML과 CSS를 수정하지 마세요. 작성할 자바스크립트는 어떤 요소에서도 동작할 수 있는 범용성이 있어야 합니다.

<br />

<img src="../../images/commons/icons/circle-answer.svg" />

`mouse.onclick`으로 클릭 이벤트를 핸들링하고 `position:fixed`로 쥐가 이동할 수 있도록 준비합니다. 이 상태에서 `mouse.onkeydown`로 화살표 키를 핸들링합니다.

문제의 핵심은 `keydown`은 오직 포커스된 요소에서만 트리거 된다는 점입니다. 따라서 원하는 요구사항을 구현하려면 요소에 `tabindex`를 추가해줘야 합니다. 그런데 문제에서 HTML을 수정하지 말라고 했으므로 속성값 추가 말고 `mouse.tabIndex` 프로퍼티를 사용해야 합니다.

참고: 해답에서 `mouse.onclick`을 `mouse.onfocus`로 바꿔도 잘 동작합니다.

[샌드박스를 열어 정답을 확인해보세요.](https://plnkr.co/edit/yxSbp0d8yIP13Ex6?p=preview)
