`DOMContentLoaded` · `load` · `[before]unload` <sub>(이벤트)</sub>
===================================================

### HTML 문서 생명주기 이벤트 <sub>(3가지)</sub>

#### `DOMContentLoaded`

##### HTML 전부 읽고 DOM 트리 완성 즉시 발생
- 기타 자원 로드 대기 X
  - 이미지 파일 <sub>(`<img>`)</sub>
  - 스타일시트
  - 기타 등등

##### 용도
- 인터페이스 초기화 등
  1. DOM 준비 확인
  2. 원하는 DOM 노드 찾아 핸들러 등록

#### `load`

##### 모든 작업 완료 시 발생
  - HTML 문서 → DOM 트리 생성
  - 외부 자원 로드
    - 이미지
    - 스타일시트
    - 기타 등등

##### 용도
- 이미지 사이즈 확인 등
- 외부 자원 로드 <sub>(스타일 적용)</sub> 후 발생
  - 화면 내 요소 실제 크기 확인 가능

#### `[before]unload`
- 사용자 페이지 떠날 때 발생

##### `beforeunload` 용도
- 사용자 떠나기 전
  - 미변경 사항들 저장 여부 확인

##### `unload` 용도
- 사용자 진짜 떠나기 전
  - 사용자 분석 정보 <sub>(통계자료)</sub> 전송

### `DOMContentLoaded` <sub>(이벤트)</sub>

##### `document` <sub>(객체)</sub> 대상 발생
- `addEventListener` <sub>(메서드)</sub> 사용
```javascript
// on<event> (HTML 속성 · DOM 프로퍼티)
// - 동작 X
document.addEventListener("DOMContentLoaded", ready);
```
```html
<script>
  function ready() {
    alert('DOM이 준비되었습니다!');

    // 이벤트 발생 시점
    // - 이미지 로드 X
    //   - 사이즈: 0x0
    alert(`이미지 사이즈: ${img.offsetWidth}x${img.offsetHeight}`);
  }

  document.addEventListener("DOMContentLoaded", ready);
</script>

<img id="img" src="https://en.js.cx/clipart/train.gif?speed=1&cache=0">
```

##### `DOMContentLoaded` 핸들러
- 문서 로드 시 실행
  - 모든 요소 접근 가능
  - 기타 자원 <sub>(이미지 등)</sub> 로드 대기 X

#### `DOMContentLoaded` · `script`

##### HTML 문서 처리 도중 `<script>` <sub>(태그)</sub> 도달 시
1. DOM 트리 구성 중단
2. `<script>` <sub>(태그)</sub> 실행
3. 스크립트 실행 종료 후
    - 나머지 HTML 문서 처리
- 문서 내 모든 `<script>` <sub>(태그)</sub> 처리 후
  - `DOMContentLoaded` <sub>(이벤트)</sub> 발생

##### 이유
- `<script>` <sub>(태그)</sub> 안
  - DOM 조작 관련 로직 존재 가능성 有
```html
<script>
  document.addEventListener("DOMContentLoaded", () => {
    alert("DOM이 준비되었습니다!");
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.3.0/lodash.js"></script>

<script>
  alert("라이브러리 로드 후 인라인 스크립트 실행");
</script>
```

##### 얼럿창 출력 순서
1. `"라이브러리 로드 후 인라인 스크립트 실행"`
2. `"DOM이 준비되었습니다!"`
- 스크립트 전부 실행 후
  - `DOMContentLoaded` <sub>(이벤트)</sub> 발생

<br />

<img src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **`DOMContentLoaded` 막지 않는 스크립트**

##### 예외 스크립트 <sub>(2가지)</sub>
1. `async` <sub>(속성)</sub> 有
2. 동적 생성 후 추가
```javascript
let script = document.createElement('script');
body.append(script);
```

<br />

#### `DOMContentLoaded` · 스타일

##### 외부 스타일시트
- DOM 영향 X
  - 로드 대기 X

##### 예외사항 <sub>(1가지)</sub>
- `script` <sub>(태그)</sub>
  - 스타일 로드 태그 직후 위치 시
    - 스타일 로드 전까지 실행 X
- `DOMContentLoaded`
  - 스크립트 대기
  - 해당 스타일 <sub>(스크립트 직전 위치)</sub> 대기

##### 이유
- 스타일 영향 받는 요소 프로퍼티 사용 가능성 有
  - 직후 스크립트 안
```html
<link type="text/css" rel="stylesheet" href="style.css">
<script>
  /* 위 스타일시트 로드 전까지 스크립트 실행 X
   스크립트 내 요소 좌표 정보 사용
   - 스타일 로드 완료 · 적용 후
     - 좌표 정보 확정
   */
  alert(getComputedStyle(document.body).marginTop);
</script>
```

#### 브라우저 내장 자동완성

##### 폼 자동완성 <sub>(Firefox · Chrome · Opera)</sub>
- `DOMContentLoaded` <sub>(이벤트)</sub> 내 동작

##### 아이디 · 비밀번호 입력 폼 <sub>(브라우저 내 인증 정보 저장)</sub>
- `DOMContentLoaded` <sub>(이벤트)</sub> 발생 시
  - 인증 정보 자동 입력 <sub>(자동 완성 허용)</sub>

##### 긴 스크립트 → `DOMContentLoaded` <sub>(이벤트)</sub> 지연
- 핸들러 내 동작 지연
  - 자동완성 처리
  - 기타 등등

### `window.onload`

##### `load` <sub>(`window` 객체 이벤트)</sub>
- 기타 리소스들 모두 로드 후 실행
  - 스타일
  - 이미지
  - 기타 등등
- `onload` <sub>(프로퍼티)</sub>
  - 핸들러 설정

##### 전체 이미지 로드 완료 후 실행
- 이미지 사이즈 정상 출력
```html
<script>
  // window.addEventListener('load', (event) => { … });
  window.onload = function() {
    alert('페이지 전체가 로드되었습니다.');

    // 이미지 정상 로드 후 alert (함수) 실행
    alert(`이미지 사이즈: ${img.offsetWidth}x${img.offsetHeight}`);
  };
</script>

<img id="img" src="https://en.js.cx/clipart/train.gif?speed=1&cache=0">
```

### `window.onunload`

##### `unload` <sub>(`window` 객체 이벤트)</sub>
- 사용자 페이지 떠날 때 <sub>(문서 완전히 닫을 때)</sub> 발생
- 지연 없는 작업 수행 가능

##### 분석 정보 서버 전송 <sub>(예외사항)</sub>
- 지연 발생 가능

##### [`navigator.sendBeacon(url, data)`](https://w3c.github.io/beacon/)
- 백그라운드 내 데이터 전송
- 타 페이지 전환 시
  - 분석 정보 서버 전송 정상 동작
  - 지연 발생 X
- 요청 전송
  - POST 메서드
- 전송 대상 <sub>(대개 문자열 형태 객체)</sub>
  - 문자열
  - 폼
  - 기타 포맷
- 전송 데이터 용량
  - 64kb 이하
- 요청 종료 시점
  - 타 페이지 전환 완료 상태 확률 ↑
  - 서버 응답 받을 방법 X
- 사용자 분석 정보 관련 응답
  - 대개 빈 상태
- `fetch` <sub>(메서드)</sub>
  - '페이지 떠난 후' 요청 가능
    - `keepalive` <sub>(플래그)</sub> 지원
```javascript
let analyticsData = { /* 분석 정보 객체 */ };

window.addEventListener("unload", function() {
  navigator.sendBeacon("/analytics", JSON.stringify(analyticsData));
};
```

##### 타 페이지 전환 취소
- `unload` X
- `onbeforeunload` 사용

### `window.onbeforeunload`

##### `beforeunload` <sub>(이벤트)</sub>
- 사용자 페이지 떠나려 할 때 <sub>(창 닫으려 할 때)</sub> 발생
- 추가 확인 요청 동작 수행

##### `beforeunload` <sub>(이벤트)</sub> 취소
- `false` 반환
- 비어있지 않은 문자열 반환 <sub>([명세서](https://html.spec.whatwg.org/#unloading-documents) 권장 X)</sub>
  - 역사적 이유
    - 과거 문자열 반환 시 표시
  - 모던 브라우저
    - 표시 X
    - 커스터마이징 X
- 사용자에 확인 요청 <sub>(브라우저)</sub>
```javascript
window.onbeforeunload = function() {
  return false;
};
window.onbeforeunload = function() {
  return "저장되지 않은 변경사항이 있습니다. 정말 페이지를 떠나실 건 가요?";
};
```

### `document.readyState` <sub>(프로퍼티)</sub>
- 현재 문서 로딩 상태 정보

##### 프로퍼티 값 <sub>(3종류)</sub>
- "`loading`"
  - 문서 로드 중
- "`interactive`"
  - 문서만 로드 완료
- "`complete`"
  - 문서 · 리소스 <sub>(이미지 등)</sub> 로드 완료

##### `document.readyState` 값 확인
- 상황 맞게 핸들러 설정 · 코드 실행
```javascript
function work() { /* … */ }

if (document.readyState == 'loading') {
  // 아직 로딩 중
  // - 이벤트 대기
  document.addEventListener('DOMContentLoaded', work);
} else {
  // DOM 완성
  work();
}
```

##### `readystatechange` <sub>(이벤트)</sub>
- 현재 문서 로딩 상태 확인
  - 상태 맞게 작업 수행
- 요즘 드물게 사용

##### 상태 변화 출력
- 개발자 도구 콘솔창
```javascript
// 현재 상태
console.log(document.readyState);

// 상태 변경 출력
document.addEventListener('readystatechange', () => console.log(document.readyState));
```

이제 마무리로 지금까지 배운 이벤트들의 순서에 대해 정리해봅시다.

아래 예시엔 이벤트를 로깅하는 `<iframe>`과 `<img>`를 비롯한 여러 이벤트 핸들러가 있습니다.
```html
<script>
  log('초기 readyState:' + document.readyState);

  document.addEventListener('readystatechange', () => log('readyState:' + document.readyState));
  document.addEventListener('DOMContentLoaded', () => log('DOMContentLoaded'));

  window.onload = () => log('window onload');
</script>

<iframe src="iframe.html" onload="log('iframe onload')"></iframe>

<img src="http://en.js.cx/clipart/train.gif" id="img">
<script>
  img.onload = () => log('img onload');
</script>
```

실행 결과는 다음과 같습니다.
1. [1] initial readyState:loading
2. [2] readyState:interactive
3. [2] DOMContentLoaded
4. [3] iframe onload
5. [4] img onload
6. [4] readyState:complete
7. [4] window onload

대괄호 안에 있는 숫자는 실제 해당 로그가 출력되기까지 걸린 시간을 나타냅니다. 같은 숫자는 1 미리 초 오차 범위 내에서 동시에 실행된 이벤트라는 것을 의미합니다.
- `document.readyState`는 `DOMContentLoaded`가 실행되기 바로 직전에 `interactive`가 됩니다. 따라서 `DOMContentLoaded`와 `interactive`는 같은 상태를 나타낸다고 볼 수 있습니다.
- `document.readyState`는 `iframe`, `img`를 비롯한 리소스 전부가 로드되었을 때 `complete`가 됩니다. 위 예시에서 우리는 `readyState`의 값이 `img.onload`와 `window.onload`가 실행된 시점과 거의 동일한 시점에 `complete`로 바뀌었다는 것을 확인할 수 있습니다. `readyState`의 값이 `complete`로 바뀐다는 것은 `window.onload`가 실행된다는 것과 동일한 의미입니다. 이 둘의 차이점은 `window.onload`는 다른 load 핸들러가 전부 실행된 후에야 동작한다는 것에 있습니다.

<br />

## 요약
페이지 로드 관련 이벤트는 다음과 같습니다.
- `DOMContentLoaded` – DOM 구성이 완료되었을 때 `document` 객체에서 실행됩니다. 자바스크립트를 사용해 요소를 조작하는 것은 이 이벤트가 실행된 후입니다.
  - `<script>...</script>`나 `<script src="..."></script>`를 사용해 삽입한 스크립트는 DOMContentLoaded가 실행되는 것을 막습니다. 브라우저는 이 스크립트가 실행되길 기다립니다.
  - `DOMContentLoaded`는 실행되어도 이미지를 비롯한 기타 리소스들은 여전히 로드 중일 수 있습니다.
- `load` – 페이지를 비롯한 이미지 등의 자원 전부가 모두 불러와졌을 때 `window` 객체에서 실행됩니다. 모든 자원이 로드되는 걸 기다리기에는 시간이 오래 걸릴 수 있으므로 이 이벤트는 잘 사용되지 않습니다.
- `beforeunload` – 사용자가 페이지를 떠나려 할 때 `window` 객체에서 발생합니다. 이 이벤트를 취소하려 하면 브라우저는 사용자에게 "we have unsaved changes…"등의 메시지를 띄워 정말 페이지를 떠날 건지 물어봅니다.
- `unload` – 사용자가 최종적으로 사이트를 떠날 때 `window` 객체에서 발생합니다. `unload` 이벤트 핸들러에선 지연을 유발하는 복잡한 작업이나 사용자와의 상호작용은 할 수 없습니다. 이 제약사항 때문에 `unload` 이벤트는 아주 드물게 사용됩니다. 하지만 예외적으로 `navigator.sendBeacon`을 사용해 네트워크 요청을 보낼 수 있습니다.
- `document.readyState` – 문서의 현재 상태를 나타내줍니다. `readystatechange` 이벤트를 사용하면 변화를 추적할 수 있습니다.
  - `loading` – 문서를 불러오는 중일 때
  - `interactive` – 문서가 완전히 불러와졌을 때. `DOMContentLoaded`가 실행되기 바로 직전에 해당 값으로 변경됩니다.
  - `complete` – 문서를 비롯한 이미지 등의 리소스들도 모두 불러와졌을 때. `window.onload`가 실행되기 바로 직전에 해당 값으로 변경됩니다.
