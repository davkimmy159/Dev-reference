`defer` · `async` 스크립트
====================

##### 모던 웹브라우저 상 대다수 스크립트
- HTML 보다 '무거움'
- 큰 용량
  - 다운로드 · 처리 시간 ↑

##### HTML 파싱 중 `<script [src="…"]>` <sub>(태그)</sub> 도달 시
- 스크립트 먼저 실행 · 로드
  - DOM 생성 일시 중단

#### 중요 이슈 발생 <sub>(부작용)</sub>

##### 1. 스크립트 아래 DOM 요소 접근 X <sub>(스크립트 내)</sub>
- 다양한 동작 수행 X
  - DOM 요소 핸들러 설정
  - 기타 등등

##### 2. 용량 큰 스크립트 <sub>(페이지 위쪽)</sub>
- 스크립트 의해 페이지 '막힘'
- 스크립트 로드 · 실행 전
  - 아래쪽 페이지 볼 수 없음
```html
<p> … 스크립트 앞 콘텐츠 … </p>

<script src="https://javascript.info/article/script-async-defer/long.js?speed=1"></script>

<!-- 스크립트 다운로드 및 실행 완료 전까지 아래 내용 안 보임 -->
<p> … 스크립트 뒤 콘텐츠 … </p>
```

##### 페이지 최하단 스크립트 위치 <sub>(우회 방법)</sub>
- 스크립트 위 요소 접근 가능
- 페이지 콘텐츠 출력 막기 X
```html
<body>
  … 스크립트 위 콘텐츠들 …

  // 스크립트 위치
  // - 문서 내 최하단
  <script src="https://javascript.info/article/script-async-defer/long.js?speed=1"></script>
</body>
```

##### 아주 큰 HTML 문서
- HTML 문서 전체 로드 후 스크립트 로드 시
  - 페이지 로드 속도 ↓

### `defer` <sub>(속성)</sub>

#### 지연 <sub>(`defer`)</sub> 스크립트

##### 백그라운드 다운로드 수행
- HTML 파싱 중단 X
- 페이지 생성 막기 X

##### 스크립트 실행 지연
- 페이지 구성 완료 전까지
```html
<p> … 스크립트 앞 콘텐츠 … </p>

<!-- defer (속성) 추가 -->
<script defer src="https://javascript.info/article/script-async-defer/long.js?speed=1"></script>

<!-- 바로 볼 수 있네요! -->
<p> … 스크립트 뒤 콘텐츠 … </p>
```

##### 실행 시점
- DOM 준비 후
- `DOMContentLoaded` <sub>(이벤트)</sub> 발생 전
```html
<p> … 스크립트 앞 콘텐츠 … </p>

<script>
  document.addEventListener('DOMContentLoaded', () => alert("`defer` 스크립트가 실행된 후, DOM이 준비되었습니다!")); // (2)
</script>

<script defer src="https://javascript.info/article/script-async-defer/long.js?speed=1"></script>

<p> … 스크립트 뒤 콘텐츠 … </p>
```
1. 페이지 콘텐츠
    - 바로 출력
2. `DOMContentLoaded` <sub>(이벤트)</sub>
    - 지연 스크립트 실행 대기
- DOM 트리 완성 · 지연 스크립트 실행 후
  - 얼럿창 출력

##### 지연 스크립트 간 순서
- HTML 추가 순서
  - 상대순
  - 요소순

#####  긴 스크립트 앞 · 짧은 스크립트 뒤
- 짧은 스크립트
  - 긴 스크립트 실행 대기
```html
<script defer src="https://javascript.info/article/script-async-defer/long.js"></script>
<script defer src="https://javascript.info/article/script-async-defer/small.js"></script>
```

<br />

<img src="../../images/commons/icons/circle-exclamation-solid.svg" /> **작은 스크립트 : 먼저 다운로드 · 나중 실행**

##### 브라우저 성능 고려
- 페이지 내 스크립트들 체크 후
  - 병렬적 다운로드 실행
- 다운로드 완료 순서
  1. 작은 파일 <sub>(`small.js`)</sub>
  2. 큰 파일 <sub>(`long.js`)</sub>
- 실행 순서 <sub>(문서 추가 순서 · 명세서 정의)</sub>
  1. 큰 파일 <sub>(`long.js`)</sub>
  2. 작은 파일 <sub>(`small.js`)</sub>

<br />

<img src="../../images/commons/icons/circle-exclamation-solid.svg" /> **`defer` <sub>(속성)</sub> : 외부 스크립트만 유효**

##### `src` <sub>(속성)</sub> 부재 `<script>`
- `defer` <sub>(속성)</sub> 무시

<br />

### `async` <sub>(속성)</sub>

#### 비동기 <sub>(`async`)</sub> 스크립트
- 페이지와 완전히 독립적으로 동작

##### 백그라운드 다운로드 수행
- HTML 파싱 중단 X
- 페이지 생성 막기 X

##### 다운로드 후 스크립트 실행 중
- HTML 파싱 중단 X

#### `DOMContentLoaded` <sub>(이벤트)</sub> · 비동기 스크립트
- 서로 대기 X

##### 이벤트 먼저 발생 시 순서 <sub>(비동기 스크립트 다운로드 전)</sub>
1. 페이지 구성 완료
2. 비동기 스크립트 다운로드 완료

##### 이벤트 나중 발생 시 순서 <sub>(비동기 스크립트 실행 후)</sub>
1. 비동기 스크립트 <sub>(짧은 코드)</sub>
    - 다운로드 완료
    - 캐싱 처리
2. 페이지 구성 완료

##### 타 스크립트 · 비동기 스크립트
- 서로 대기 X

##### 다수 바동기 <sub>(`async`)</sub> 스크립트
- 실행 순서
  - 다운로드 완료 순서 <sub>(제각각)</sub>
```html
<p> … 스크립트 앞 콘텐츠 … </p>

<script>
  document.addEventListener('DOMContentLoaded', () => alert("DOM이 준비 되었습니다!"));
</script>

<script async src="https://javascript.info/article/script-async-defer/long.js"></script>
<script async src="https://javascript.info/article/script-async-defer/small.js"></script>

<p> … 스크립트 뒤 콘텐츠 … </p>
```

##### 1. 콘텐츠 바로 출력
- 비동기 스크립트 다운로드
  - 페이지 로드 막기 X

##### 2. `DOMContentLoaded` <sub>(이벤트)</sub>
- 비동기 스크립트 전 · 후 실행
  - 상황 따라 상이
  - 정확한 순서 예측 X

##### 3. 비동기 스크립트
- 서로 대기 X
- 다운로드 완료 시 먼저 실행
  - 'load-first order'

##### 서드파티 스크립트 → 현재 개발 중인 스크립트 <sub>(통합)</sub>
- 각각 독립적인 역할 수행
  - 방문자 수 카운터
  - 광고 관련 스크립트
- 비동기 스크립트 · 개발 중인 스크립트
  - 서로 의존 X
```html
<!-- Google Analytics -->
<script async src="https://google-analytics.com/analytics.js"></script>
```

### 동적 스크립트

##### 스크립트 동적 추가
```javascript
let script = document.createElement('script');
script.src = "/article/script-async-defer/long.js";

// 스크립트 관련 요소
// - 문서 내 추가 즉시 다운로드 시작
document.body.append(script);
```

##### 특징 <sub>(비동기 스크립트 유사)</sub>
- 동적 스크립트 · 타 요소 · 이벤트
  - 서로 대기
- 다운로드 완료 시 먼저 실행
  - 'load-first order'

##### 스크립트 2개 동적 생성 후 추가
- `script.async = false`
  - 비동기 설정 해제
- 실행 순서 <sub>(문서 추가 순서)</sub>
  1. `long.js`
  2. `small.js`
```javascript
function loadScript(src) {
  let script = document.createElement('script');
  script.src = src;

  // 비동기 설정 해제
  script.async = false;
  document.body.append(script);
}

// 실행 순서 (문서 추가 순서)
// 1. long.js
// 2. small.js
loadScript("/article/script-async-defer/long.js");
loadScript("/article/script-async-defer/small.js");
```
<br />

## 요약
`async`와 `defer` 스크립트는 다운로드 시 페이지 렌더링을 막지 않는다는 공통점이 있습니다. 따라서 `async`와 `defer`를 적절히 사용하면 사용자가 오래 기다리지 않고 페이지 콘텐츠를 볼 수 있게 할 수 있습니다.

두 스크립트의 차이점은 다음과 같습니다.

||순서|`DOMContentLoaded`|
|---|---|---|
|`async`|load-first order. 문서 내 순서와 상관없이 먼저 다운로드된 스크립트가 먼저 실행됩니다.|비동기 스크립트는 HTML 문서가 완전히 다운로드되지 않은 상태라도 로드 및 실행될 수 있습니다. 스크립트 크기가 작거나 캐싱 처리 되어있을 때 혹은 HTML 문서 길이가 아주 길 때 이런 일이 발생합니다.|
|`defer`|문서에 추가된 순|지연 스크립트는 문서 다운로드와 파싱이 완료된 후에, `DOMContentLoaded` 이벤트 발생 전에 실행됩니다.|

<br />

<img src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **스크립트 다운로드가 끝나지 않았어도 페이지는 동작해야 합니다.**

`defer`를 사용하게 되면 스크립트가 실행되기 전 에 페이지가 화면에 출력된다는 점에 항상 유의해야 합니다.

사용자는 그래픽 관련 컴포넌트들이 준비되지 않은 상태에서 화면을 보게 될 수 있죠.

따라서 지연 스크립트가 영향을 주는 영역엔 반드시 '로딩 인디케이터'가 있어야 합니다. 관련 버튼도 사용 불가(disabled) 처리를 해줘야 하죠. 이렇게 해야 사용자에게 현재 어떤 것은 사용할 수 있는지, 어떤 것은 사용할 수 없는지를 알려줄 수 있습니다.

<br />

실무에선 `defer`를 DOM 전체가 필요한 스크립트나 실행 순서가 중요한 경우에 적용합니다. `async`는 방문자 수 카운터나 광고 관련 스크립트같이 독립적인 스크립트에 혹은 실행 순서가 중요하지 않은 경우에 적용합니다.

![image-1](../../images/02/05/02/image-1.png)
![image-2](../../images/02/05/02/image-2.png)
