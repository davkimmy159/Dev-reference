이벤트 위임
==========

- 강력한 이벤트 핸들링 패턴
- 캡처링 · 버블링 이용

##### 다수 요소 비슷한 방식 처리
- 요소별 핸들러 할당 X
- 공통 조상 핸들러 하나 할당
  - `event.target`
    - 이벤트 발생 위치 파악

#### ex\) [팔괘도 <sub>(Ba-Gua diagram)</sub>](https://en.wikipedia.org/wiki/Ba_gua)

![Ba-Gua-diagram](../../images/02/02/03/Ba-Gua-diagram.png)

```html
<table>
  <tr>
    <th colspan="3"><em>Bagua</em> Chart: Direction, Element, Color, Meaning</th>
  </tr>
  <tr>
    <td class="nw"><strong>Northwest</strong><br>Metal<br>Silver<br>Elders</td>
    <td class="n">…</td>
    <td class="ne">…</td>
  </tr>
  <tr>… 2 more lines of this kind …</tr>
  <tr>… 2 more lines of this kind …</tr>
</table>
```


##### `<td>` <sub>(요소)</sub> 이벤트 처리
- 요소 클릭 시 해당 칸 강조
  - 갯수 상관 X
- 각 `<td>` <sub>(요소)</sub>
  - `onclick` <sub>(핸들러)</sub> 할당 X
- `<table>` <sub>(요소)</sub>
  - '모든 이벤트 잡아내는' 핸들러 할당

##### `<table>` <sub>(요소)</sub> 할당 핸들러
- 클릭 요소 감지 · 해당 칸 강조 
  - `event.target` 이용
```javascript
let selectedTd;

table.onclick = function(event) {

  // 이벤트 발생 위치 (요소)
  let target = event.target;

  // TD 외 요소
  // - 무시
  if (target.tagName != 'TD') return;

  // 해당 칸 강조
  highlight(target);
};

function highlight(td) {

  // 이미 강조된 칸
  // - 원상태 복구
  if (selectedTd) {
    selectedTd.classList.remove('highlight');
  }
  selectedTd = td;

  // td (요소) 강조
  selectedTd.classList.add('highlight');
}
```

#### 개선점

##### `<td>` <sub>(요소)</sub> 내 중첩 요소 발생 이벤트
- `event.target`
  - `<td>` <sub>(요소)</sub> X
  - 중첩 요소 <sub>(`<strong>` 등)</sub>
```html
<td>
  <strong>Northwest</strong>
  …
</td>
```

##### `td` <sub>(요소)</sub> 내 `<strong>` <sub>(요소)</sub> 클릭 시
- `event.target`
  - `<strong>` <sub>(요소)</sub>

![bagua-bubble](../../images/02/02/03/bagua-bubble.svg)

##### `table.onclick` <sub>(핸들러)</sub>
- 이벤트 발생 위치 파악 <sub>(`<td>` 요소 안쪽 여부)</sub>
  - `event.target` 이용

##### 개선된 코드
```javascript
table.onclick = function(event) {

  /* elem.closest(selector) (메서드)
   최근접 조상 요소 반환
   - elem 상위 요소 중 selector 일치 조건
   이벤트 발생 요소 → 최상위 요소 (방향)
   - 최근접 <td> (요소) 검색
   */
  let td = event.target.closest('td');

  /* event.target ≠  <td> (요소)
   - 즉시 `null` 반환
     - 어떤 작업도 발생 X
   */
  if (!td) return;

  /* 중첩 테이블 존재 시
   event.target
   - 현재 테이블 외부 <td> (요소) 가능
   <td> (요소)
   - 팔괘도 내 위치 여부 확인
   */
  if (!table.contains(td)) return;

  // <td> (요소) 강조
  highlight(td);
};
```

### 이벤트 위임 활용하기

#### ex\) `Menu` 구현

##### 객체 <sub>(버튼 기능 메서드 구현)</sub>
- `save`
  - 저장하기 <sub>(버튼)</sub>
- `load`
  - 불러오기 <sub>(버튼)</sub>
- `search`
  - 검색하기 <sub>(버튼)</sub>

##### 메서드 · 버튼 연결 방법 <sub>(2가지)</sub>
1. 각 버튼 독립 핸들러 할당
2. 메뉴 전체 핸들러 하나 추가
    - 각 버튼 `data-action` <sub>(속성)</sub>
      - 호출 메서드 할당
   - 핸들러
     - 속성값 읽고 메서드 실행
```html
<div id="menu">
  <button data-action="save">저장하기</button>
  <button data-action="load">불러오기</button>
  <button data-action="search">검색하기</button>
</div>

<script>
  class Menu {
    constructor(elem) {
      this._elem = elem;

      /* this.onClick → this 바인딩
       바인딩 시
       - this → Menu (객체)
         - this[action] → menu[action]
       생략 시
       - this → elem (DOM 요소) 참조
         - this[action] → elem[action]
       */
      elem.onclick = this.onClick.bind(this);
    }

    save() { alert('저장하기'); }
    load() { alert('불러오기'); }
    search() { alert('검색하기'); }

    onClick(event) {
      let action = event.target.dataset.action;
      if (action) {
        this[action]();
      }
    };
  }

  new Menu(menu);
</script>
```

![utilizing-event-delegation](../../images/02/02/03/utilizing-event-delegation.png)

##### 장점
- 각 버튼별 핸들러 할당 코드 X
  - 메서드 작성 · HTML 내 삽입
- 언제든 버튼 추가 · 제거 가능
  - 유연한 HTML 구조

##### 속성 대신 클래스 사용 가능
- `.action-save`
- `.action-load`
- 기타 등등

##### `data` <sub>(속성)</sub>
- 의미론적으로 클래스보다 좀 더 나음

##### CSS 규칙 적용 가능

### '행동' 패턴

##### 이벤트 위임
- 요소에 선언적 방식 '행동' 추가
  - 특별한 속성 · 클래스 사용

#### 행동 패턴 구성 <sub>(2부분)</sub>

##### 1. 요소 : 커스텀 속성 추가
- 요소 행동 설명

##### 2. 문서 전체 감지 핸들러
- 이벤트 추적
- 커스텀 속성 요소 이벤트 발생 시
  - 작업 수행

#### 카운터 구현하기
- `data-counter` <sub>(속성)</sub>
  - 행동 <sub>(버튼 클릭 시 숫자 증가)</sub> 부여
```html
첫 번째 카운터: <input type="button" value="1" data-counter>
두 번째 카운터: <input type="button" value="2" data-counter>

<script>
  document.addEventListener('click', function(event) {

    // 속성 존재 시 실행
    if (event.target.dataset.counter != undefined) {
      event.target.value++;
    }

  });
</script>
```

![behaviour-pattern-implementing-counter](../../images/02/02/03/behaviour-pattern-implementing-counter.png)

##### `data-counter` <sub>(속성)</sub> 요소
- 생성 제한 X
  - 필요 때마다 추가
- 새 행동 선언 속성 추가
  - HTML '확장'

<br />

<img src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **문서 레벨 핸들러 : 항상 `addEventListener` 사용**

##### `document` <sub>(객체)</sub> 핸들러 할당
- `addEventListener` 사용
- `document.onclick` X
  - 충돌 발생 가능
  - 새 핸들러
    - 이전 핸들러 덮어쓸 수 있음
- 코드 내 여기저기
  - 다수 핸들러 할당
    - 자연스러운 일

<br />

#### ex\) 토글러 구현

##### `data-toggle-id` <sub>(속성)</sub> 요소
- 클릭 시 해당 속성값 요소 토글
  - 보이기 · 숨기기
- `data-toggle-id` <sub>(속성)</sub> 추가 시
  - 요소 토글 가능
```html
<button data-toggle-id="subscribe-mail">
  구독 폼 보여주기
</button>

<form id="subscribe-mail" hidden>
  메일 주소: <input type="email">
</form>

<script>
  document.addEventListener('click', function(event) {
    let id = event.target.dataset.toggleId;
    if (!id) return;

    let elem = document.getElementById(id);

    elem.hidden = !elem.hidden;
  });
</script>
```

![behaviour-pattern-implementing-toggler](../../images/02/02/03/behaviour-pattern-implementing-toggler.png)

##### 행동 패턴 응용
- 해당 기능 필요 요소 전체
  - 기능 구현 필요 X <sub>(매우 편리)</sub>
  - '행동' 선언
- 문서 레벨 핸들러 구현
  - 페이지 내 모든 요소
    - 행동 쉽게 적용
- 한 요소
  - 다수 행동 조합해 적용
- JS 미니 프래그먼트 대안

<br />

## 요약

##### 이벤트 위임
- 유사 요소 동일 핸들러 적용

##### 동작 알고리즘
1. 컨테이너 하나
    - 핸들러 할당
2. 이벤트 발생 요소 파악
    - 핸들러 내 `event.target`
3. 요소 확인 후
    - 이벤트 처리

##### 장점
- 다수 핸들러 할당 X
  - 초기화 단순
  - 메모리 절약
- 요소 추가 · 제거 시
  - 해당 요소 할당 핸들러 수정 X
  - 속성 수정
    - 코드량 ↓
- DOM 수정 용이
  - `innerHTML` · 유사 기능 스크립트
    - 요소 덩어리 더하기 · 빼기 가능

##### 단점
- 이벤트 버블링 필수
  - 몇몇 이벤트 버블링 X
- 저레벨 할당 핸들러
  - `event.stopPropagation()` X
- 컨테이너 수준 할당 핸들러
  - 모든 하위 발생 이벤트 응답
    - CPU 작업 부하 ↑ <sub>(무시 가능 수준)</sub>

<br />

## <img src="../../images/commons/icons/circle-check-solid.svg" /> 과제

### 이벤트 위임 사용해 메시지 숨기기

##### 메시지 목록
- 각 메시지 내 삭제 버튼 <sub>(`[x]`)</sub> 존재

##### 이벤트 리스너 1개로 삭제 버튼 <sub>(`[x]`)</sub> 동작
- 이벤트 위임 사용

![assignment-hide-message-using-event-delegation](../../images/02/02/03/assignment-hide-message-using-event-delegation.png)

<br />

<img src="../../images/commons/icons/circle-answer.svg" />

[정답](https://plnkr.co/edit/Gln3COwjRb6E7LA9?p=preview)

<hr />

### 트리 메뉴 구현하기

##### 트리 메뉴 구현
- 노드 클릭 시
  - 자손 노드 토글 <sub>(보이기 · 숨기기)</sub>

![assignment-implementing-tree-menu](../../images/02/02/03/assignment-implementing-tree-menu.png)

##### 요구사항
- 이벤트 핸들러 1개 사용
  - 이벤트 위임 사용
- 텍스트 노드 외부 <sub>(빈 곳)</sub> 클릭 시
  - 아무 일 발생 X

<br />

<img src="../../images/commons/icons/circle-answer.svg" />

##### 1. 트리 내 모든 텍스트 : `<span>` <sub>(요소)</sub> 감싸기
- `:hover` <sub>(CSS 프로퍼티)</sub> 적용
  - 마우스 오버 시 굻은 글씨 효과
- `<span>` <sub>(요소)</sub> 차지 너비 == 텍스트 너비
  - 텍스트에만 클릭 이벤트 동작

##### 2. `tree` <sub>(루트 노드)</sub> 핸들러 추가
- 클릭 이벤트
  - `<span>` <sub>(요소)</sub> 감싼 텍스트에만 동작

[샌드박스를 열어 정답을 확인해보세요.](https://plnkr.co/edit/S9Y0B68rHv8DNbJx?p=preview)

<hr />

### 정렬 기능을 제공하는 표
열 제목을 나타내는 요소인 `<th>`를 클릭하면 열 전체가 정렬되는 표를 만들어보세요.

모든 `<th>` 속성엔 다음과 같이 데이터의 타입이 정의되어 있습니다.
```html
<table id="grid">
  <thead>
    <tr>
      <th data-type="number">나이</th>
      <th data-type="string">이름</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>5</td>
      <td>일리야</td>
    </tr>
    <tr>
      <td>10</td>
      <td>보라</td>
    </tr>
    ...
  </tbody>
</table>
```

위 예시에선 첫 번째 열엔 숫자가, 두 번째 열엔 문자열이 들어갑니다. 구현할 정렬 함수는 데이터 타입에 맞게 정렬을 해줘야 합니다.

이 문제에선 '숫자'와 '문자열' 타입만 다룬다고 가정하겠습니다.

제대로 해답을 작성했다면 다음 예시처럼 동작해야 합니다.

![assignment-table-alignable](../../images/02/02/03/assignment-table-alignable.png)

P.S. 표 크기는 예시보다 훨씬 클 수 있습니다. 열이나 행이 더 추가될 수 있다는 가정하에 답을 작성해보세요.

<br />

<img src="../../images/commons/icons/circle-answer.svg" />

[샌드박스를 열어 정답을 확인해보세요.](https://plnkr.co/edit/44OZNPWoTdaMi1mR?p=preview)

<hr />

### 툴팁 보여주기
툴팁(tooltip)을 보여주는 JS 코드를 작성해봅시다.

`data-tooltip` 속성이 있는 요소에 마우스를 가져다 대면 툴팁이 보여야 하고, 마우스 커서가 요소에서 떠나면 툴팁이 사라져야 합니다.

`data-tooltip` 속성은 다음 HTML처럼 추가할 수 있습니다.
```html
<button data-tooltip="버튼 요소 길이보다 툴팁 길이가 훨씬 기네요.">짧은 버튼</button>
<button data-tooltip="두 줄짜리<br>툴팁">...또 다른 버튼...</button>
```

답을 잘 작성했다면 아래 예시처럼 동작해야 합니다.

![assignment-showing-tooltip](../../images/02/02/03/assignment-showing-tooltip.png)

`data-tooltip`이 있는 요소엔 텍스트만 있다고 가정하겠습니다. 요소 안에 다른 태그가 있는 경우는 생각하지 않기로 합시다.

자세한 요구사항은 다음과 같습니다.
- 툴팁과 요소의 간격은 `5px`입니다.
- 가능하면 툴팁은 요소를 기준으로 중앙에 있도록 합시다.
- 툴팁은 창 크기보다 커질 수 없습니다. 일반적인 경우라면 툴팁은 요소 위에 있을 텐데, 요소가 창 맨 위에 있어서 툴팁을 보여줄 공간이 없다면 툴팁은 요소 아래에 나타납니다.
- 툴팁안에 띄울 콘텐츠는 `data-tooltip` 속성에서 가져옵니다. 속성값은 HTML일 수 있습니다.

원하는 기능을 구현하려면 다음 두 가지 이벤트가 필요합니다.
- `mouseover` – 요소 안으로 포인터가 이동할 때 발생하는 이벤트
- `mouseout` – 요소 밖으로 포인터가 이동할 때 발생하는 이벤트

이벤트 위임을 사용해서 두 개의 핸들러만으로 원하는 기능을 구현하세요. `document`에 핸들러를 추가해 `data-tooltip` 속성이 있는 요소 안이나 밖으로 마우스 포인터가 이동하는 경우를 모두 감지하고 두 핸들러를 통해 툴팁을 보여주거나 감추시면 됩니다.

이렇게 툴팁 기능을 구현해 놓으면 자바스크립트에 익숙하지 않은 사람도 원하는 요소에 쉽게 툴팁을 보여줄 수 있을 겁니다.

P.S. 한 번에 한 개의 툴팁 만 보여줄 수 있습니다.

<br />

<img src="../../images/commons/icons/circle-answer.svg" />

[샌드박스를 열어 정답을 확인해보세요.](https://plnkr.co/edit/QEo1yOgcLdOZrUYn?p=preview)
