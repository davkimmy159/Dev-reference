### `samesite` <sub>(보안)</sub>

##### '크로스 사이트 요청 위조' 공격 방지
- cross-site request forgery <sub>(XSRF)</sub>

#### XSRF 공격 시나리오

##### 1. 현재 `bank.com` <sub>(은행 사이트)</sub> 로그인 상태
1. 브라우저 내 인증 쿠키 저장
    - `bank.com` 사용
2. 브라우저
    - `bank.com` 요청 전송 시
      - 인증 쿠키 함께 전송
3. 서버
    1. 사용자 식별
        - 전송받은 쿠키 이용
    2. 보안 필요한 재정 거래 처리

##### 2. 로그인 유지 중 `evil.com` <sub>(악의적 사이트)</sub> 우연히 방문
1. 사이트 내 해커 대상 송금 요청 폼 有
    - 자동 제출 설정
```javascript
<form action="https://bank.com/pay">
```
2. 폼 전송 시 <sub>(`evil.com` → `bank.com`)</sub>
    - 인증 쿠키 함께 전송
- `bank.com` 요청 전송 시
  - `bank.com` 설정 쿠키 자동 전송
3. 은행측 쿠키 수신 · 읽기
    - 계정 주인 접속 간주
      - 해커에게 돈 송금

![cookie-xsrf](../../images/03/04/01/cookie-xsrf.svg)

##### 실제 은행 시스템 설계 <sub>(XSRF 공격 방지)</sub>
- 모든 폼에 특수 필드 <sub>("XSRF 보호 토큰")</sub> 삽입
  - 악의적인 페이지 내 생성 X
  - 원격 페이지에서 훔쳐오기 X
- 악의적인 페이지 내 폼 전송 무용지물
  - 보호 토큰 X
  - 서버 저장 값 불일치

##### 구현 시간 ↑
- 모든 폼에 보호 토큰 설정
- 모든 요청 검수

#### `samesite` <sub>(옵션)</sub>
- 이론상 "XSRF 보호 토큰" 없이 공격 방지

#### 설정 값 ① <sub>(동일 동작)</sub>
- `samesite`
- `samesite=strict`

##### 사이트 외부 사용자 · 타 도메인 요청
- ex\) 링크 따라 접속 · 악의적 사이트 폼 전송 등
  - 해당 옵션 설정 쿠키 전송 X

##### 인증 쿠키 대상 옵션 설정
- XSRF 공격 절대 성공 X
- 악의적 사이트 요청
  - 쿠키 X
- 인증 사이트
  - 미인식 사용자 대상 지급 불허

##### 약간의 불편함
- 인증 사이트 링크 기록 후 접속
  - 사용자 인식 X

##### 쿠키 2개 함께 사용 <sub>(불편함 해결)</sub>
1. '일반 인증'용 쿠키
    - 환영 메시지 출력
2. `samesite=strict` 옵션 쿠키
    - 데이터 교환 시 사용
- 외부 사이트 통해 접근한 사용자
  - 환영 메시지 정상 출력
- 지급
  - 무조건 은행 사이트 통해서만 수행

#### 설정 값 ②
- `samesite=lax`

##### 느슨한 접근법
- XSRF 공격 방지
- 사용자 경험 해치지 않음

##### 기능
- `samesite=strict` 동일
  - 외부 요청 쿠키 미전송
  - 예외사항 有

#### 예외사항 <sub>(두 조건 동시 만족 시 쿠키 전송)</sub>

##### 1. "안전한" HTTP 메서드
- ex\)
  - `GET` O
  - `POST` X
- 안전한 HTTP 메서드 목록
  - [RFC7231 명세](https://datatracker.ietf.org/doc/html/rfc7231) 확인
- 안전한 메서드
  - 읽기 작업만 수행
    - ex\) 링크 통해 접속 등
  - 쓰기 · 데이터 교환 작업 X

##### 2. 최상위 레벨 탐색 내 작업 수행 <sub>(브라우저 주소창 url 변경 등)</sub>
- 조건 충족
  - 대다수 작업
- 조건 미충족
  - `<iframe>` 내 탐색
  - AJAX 요청
  - 기타 등등

##### 두 조건 충족 작업
- 특정 url 이동 <sub>(흔한 브라우저 작업)</sub>
- 저장 링크 열기 <sub>(특정 url 이동)</sub>
- 기타 등등

#### 문제점

##### 구식 브라우저 미지원 <sub>(~ 2017년)</sub>
- 보안 문제 발생 가능
- 타 보안 기법 함께 사용
  - ex\) XSRF 토큰 등

### `httpOnly` <sub>(JS 무관)</sub>

##### 웹서버
- `Set-Cookie` <sub>(헤더)</sub> 이용해 쿠키 설정 시 지정


이 옵션은 자바스크립트 같은 클라이언트 측 스크립트가 쿠키를 사용할 수 없게 합니다. `document.cookie`를 통해 쿠키를 볼 수도 없고 조작할 수도 없습니다.

해커가 악의적인 자바스크립트 코드를 페이지에 삽입하고 사용자가 그 페이지에 접속하기를 기다리는 방식의 공격을 예방할 때 이 옵션을 사용합니다. 우리가 만든 사이트에 해커가 악의적인 코드를 삽입하지 못하도록 예방해야 하지만, 버그가 있을 확률은 언제나 있기 때문에 해커가 코드를 삽입할 가능성이 있을 수 있습니다.

이런 상황이 만에 하나 발생하면, 사용자가 웹 페이지에 방문할 때 `document.cookie`를 볼 수 있고 조작도 할 수 있는 해커의 코드도 함께 실행됩니다. 물론 쿠키엔 인증 정보가 있어서 해커가 이 정보를 훔치거나 조작할 수 있게 됩니다. 좋지 않은 상황이 발생하죠.

하지만 `httpOnly` 옵션이 설정된 쿠키는 `document.cookie`로 쿠키 정보를 읽을 수 없기 때문에 쿠키를 보호할 수 있습니다.