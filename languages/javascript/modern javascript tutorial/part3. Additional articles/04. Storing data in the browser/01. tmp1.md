### `samesite` <sub>(보안 옵션)</sub>

##### '크로스 사이트 요청 위조' 공격 방지
- 'cross-site request forgery' <sub>(XSRF)</sub>

#### XSRF 공격 시나리오

##### 1. 현재 `bank.com` <sub>(은행 사이트)</sub> 로그인 상태
1. 브라우저 내 인증 쿠키 저장
    - `bank.com` 내 사용
2. 브라우저
    - `bank.com` 요청 전송
      - 인증 쿠키 포함
3. 서버
    1. 사용자 식별
        - 전송받은 쿠키 이용
    2. 보안 필요한 재정 거래 처리

##### 2. 로그인 유지 중 `evil.com` <sub>(악의적 사이트)</sub> 우연히 방문
1. 사이트 내 해커 대상 송금 요청 폼 코드 有
    - 자동 제출 <sub>(전송)</sub> 설정
```html
<form action="https://bank.com/pay">
```
2. 폼 자동 전송 <sub>(`evil.com` → `bank.com`)</sub>
    - 인증 쿠키 포함
- `bank.com` 요청 전송 시
  - `bank.com` 설정 쿠키 자동 전송
3. `bank.com` <sub>(은행 사이트)</sub>
    - 쿠키 수신 · 읽기
      - 계정 주인 접속 간주
      - 해커에게 돈 송금

![cookie-xsrf](../../images/03/04/01/cookie-xsrf.svg)

##### 실제 은행 시스템 <sub>(XSRF 공격 방지)</sub>
- 모든 폼 내 특수 필드 <sub>("XSRF 보호 토큰")</sub> 삽입
  - 악의적 페이지 내 생성 불가능
  - 원격 페이지에서 훔쳐오기 불가능
- 악의적 페이지 내 폼 전송 무용지물
  - 보호 토큰 無
  - 서버 저장 값 불일치

##### 구현 시간 ↑ <sub>(단점)</sub>
- 모든 폼 내 보호 토큰 설정
- 모든 요청 검수

#### `samesite` <sub>(옵션)</sub>
- 이론상 "XSRF 보호 토큰" 없이 공격 방지

#### 1. `samesite[=strict]`

##### 타 도메인 <sub>(사이트 외부 사용자)</sub> 요청 시 쿠키 미전송 
- 메일 내 링크 따라 접속
- 악의적 사이트 내 폼 전송
- 기타 등등

##### XSRF 공격 절대 불가능
- 악의적 사이트 전송 요청
  - 쿠키 無
- 쿠키 설정 사이트 <sub>(`bank.com` 등)</sub>
  - 보안 필요 작업 미진행
    - ex\) 미인식 사용자 돈 미지급 등

##### 사소한 불편함 有
1. 쿠키 설정 사이트 대상 요청 링크 기록
    - ex\) 메모장 등
2. 기록한 링크 통해 접속 시 쿠키 미전송
    - ex\) 사용자 인식 불가능 등

##### 쿠키 2개 함께 사용 <sub>(불편함 해결)</sub>
1. '일반 인증'용 쿠키
    - 환영 메시지 <sub>("Hello, John" 등)</sub> 출력
2. `samesite=strict` <sub>(옵션)</sub> 설정 쿠키
    - 데이터 교환 시 사용
- 외부 사이트 통해 접근한 사용자
  - 환영 메시지 정상 출력
- 보안 필요 작업 <sub>(돈 지급 등)</sub>
  - 쿠키 설정 사이트 통한 처리 강제

#### 2. `samesite=lax`

##### 느슨한 접근법
- XSRF 공격 방지
- 사용자 경험 해치지 않음

##### `samesite[=strict]` 동일
- 사이트 외부 요청 수신 시 쿠키 미전송
  - 예외 有

#### 예외 <sub>(두 조건 동시 만족 시 쿠키 전송)</sub>

##### 1. "안전한" HTTP 메서드 <sub>([목록](https://datatracker.ietf.org/doc/html/rfc7231))</sub>
- ex\) GET <sub>(POST X)</sub>
- 읽기 작업만 수행
  - ex\) 링크 통해 접속 <sub>(항상 GET)</sub> 등
- 쓰기 · 데이터 교환 작업 X

##### 2. 최상위 레벨 탐색 내 작업 수행
- ex\) 브라우저 주소창 url 변경 등
- 대다수 작업 조건 충족
- 조건 미충족 작업
  - `<iframe>` <sub>(요소)</sub> 내 탐색 <sub>(최상위 레벨 X)</sub>
  - AJAX 요청 <sub>(탐색 행위 X)</sub>
  - 기타 등등

##### 두 조건 충족 작업
- 특정 url 이동 <sub>(흔한 브라우저 작업)</sub>
- 링크 열기 <sub>(특정 url 이동)</sub>
- 기타 등등

#### 문제점

##### 구식 <sub>(2017년 이전)</sub> 브라우저 미지원
- 보안 문제 발생 가능
- 타 보안 기법 함께 사용
  - ex\) XSRF 토큰 등

### `httpOnly` <sub>(옵션 · JS 무관)</sub>

##### 옵션 설정 <sub>(웹서버)</sub>
- `Set-Cookie` <sub>(헤더)</sub> 이용해 쿠키 설정 시 지정

##### 클라이언트 스크립트 쿠키 사용 방지
- `document.cookie` <sub>(프로퍼티)</sub>
  - 쿠키 접근 <sub>(출력 · 조작)</sub> 불가능

##### 페이지 내 삽입된 악의적 JS 코드 실행 예방
- 
- 해커 코드 삽입 가능성 항상 有

해커가 악의적인 자바스크립트 코드를 페이지에 삽입하고 사용자가 그 페이지에 접속하기를 기다리는 방식의 공격을 예방할 때 이 옵션을 사용합니다. 우리가 만든 사이트에 해커가 악의적인 코드를 삽입하지 못하도록 예방해야 하지만, 버그가 있을 확률은 언제나 있기 때문에 해커가 코드를 삽입할 가능성이 있을 수 있습니다.

이런 상황이 만에 하나 발생하면, 사용자가 웹 페이지에 방문할 때 document.cookie를 볼 수 있고 조작도 할 수 있는 해커의 코드도 함께 실행됩니다. 물론 쿠키엔 인증 정보가 있어서 해커가 이 정보를 훔치거나 조작할 수 있게 됩니다. 좋지 않은 상황이 발생하죠.

하지만 httpOnly 옵션이 설정된 쿠키는 document.cookie로 쿠키 정보를 읽을 수 없기 때문에 쿠키를 보호할 수 있습니다.