쿠키 · `document.cookie`
========================

### 쿠키

##### 작은 크기 문자열
- 브라우저 내 저장

##### HTTP 프로토콜 일부
- [RFC 6265](https://datatracker.ietf.org/doc/html/rfc6265) <sub>(명세)</sub> 정의

##### 주로 웹 서버 의해 생성
1. 서버측 HTTP 응답 헤더 <sub>(`Set-Cookie`)</sub> 전송
2. 브라우저측 해당 해더 내용 자체 저장 <sub>(쿠키)</sub>
3.  브라우저측 해당 사이트 재접속 시
    - 요청 헤더 <sub>(`Cookie`)</sub> 전송
      - 쿠키 내용

#### 인증에 자주 사용 <sub>(클라이언트 식별 등)</sub>

##### 1. 사용자 로그인
- 서버측 쿠키 설정
  - '세션 식별자' 정보 이용
    - HTTP 응답 헤더 <sub>(`Set-Cookie`)</sub>

##### 2. 사용자 동일 도메인 접속
- 브라우저 요청 전송
  - 인증 정보 담긴 고윳값 <sub>(세션 식별자)</sub>
    - HTTP `Cookie` <sub>(헤더)</sub> 내 저장

##### 3. 서버측 사용자 식별
- 브라우저 요청 헤더 내 세션 식별자 읽기

##### `document.cookie` <sub>(프로퍼티)</sub>
- 브라우저 내 쿠키 접근

### 쿠키 읽기

##### `javascript.info` 관련 쿠키 확인
```javascript
// javascript.info
// - Google Analytics (GA) 사용해 데이터 수집
alert( document.cookie ); // cookie1=value1; cookie2=value2;...
```

##### `document.cookie` <sub>(프로퍼티)</sub> 값
- 쌍 구성
  - `name=value`
  - 독립된 쿠키 표현
- 구분자
  - `;` <sub>(세미콜론)</sub>

##### 쿠키 찾기
- `document.cookie` 값 분리
  - `;` <sub>(세미콜론)</sub> 기준
- 정규 표현식 · 배열 함수 함께 사용

### 쿠키 쓰기

##### `document.cookie`
- 직접 값 쓰기 가능
- 접근자 프로퍼티
- 값 할당 시
  - 해당 쿠키 갱신 <sub>(브라우저)</sub>
  - 타 쿠키 변경

##### `user` 쿠키 값 갱신
- `John`
```javascript
// 'user' 쿠키 값만 갱신
document.cookie = "user=John";

// 모든 쿠키 출력
alert(document.cookie);
```

##### 쿠키 할당 연산 <sub>(`document.cookie=`)</sub>
- 모든 쿠키 덮어쓰기 X
- 명시 쿠키 값만 갱신

##### 쿠키 이름 · 값
- 특별 제약 X
  - 모든 글자 허용
- 이름 · 값 이스케이프 처리
  - 형식 유효성 유지 필요
  - `encodeURIComponent` <sub>(내장 함수)</sub> 사용
```javascript
// 특수 값 (공백)
// - 인코딩 처리
let name = "my name";
let value = "John Smith"

// 인코딩 처리
// - my%20name=John%20Smith
document.cookie = encodeURIComponent(name) + '=' + encodeURIComponent(value);

alert(document.cookie); // …; my%20name=John%20Smith
```

<br />

<img src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **쿠키 한계**

#### 쿠키 제약 사항

##### 인코딩 후 `name=value` 쌍 용량 한정 <sub>(4KB 이하)</sub>
- 용량 초과 시 저장 X

##### 도메인 1개당 저장 가능 쿠키 개수 한정 <sub>(약 20여 개)</sub>
- 브라우저별 약간 상이

<br />

##### 쿠키 옵션
- 일부 옵션 지정 필수
- 위치
  - `key=value` 쌍 뒤 나열
- 구분자
  - `;` <sub>(세미콜론)</sub>
```javascript
document.cookie = "user=John; path=/; expires=Tue, 19 Jan 2038 03:14:07 GMT"
```

### `path` <sub>(URL 경로 접두사)</sub>
- `path=/mypath`

##### 쿠키 접근 가능 페이지 제한
- 해당 경로 · 하위 경로
- 절대 경로
- 기본값
  - 현재 경로

##### ex\) `path=/admin`
- 쿠키 접근 가능
  - `/admin`
  - `/admin/something`
  - 기타 등등
- 쿠키 접근 X
  - `/home`
  - `/adminpage`
  - 기타 등등

##### 일반적인 옵션 설정
- `path=/` <sub>(루트 설정)</sub>
  - 웹사이트 내 모든 페이지 접근 허용

### `domain`
- `domain=site.com`

##### 쿠키 접근 가능 도메인 지정
- 일부 제약 有
  - 아무 도메인 지정 X

##### 기본값
- 쿠키 설정 도메인
- ex\) `site.com` 내 설정 쿠키
  - `other.com` 접근 X

이 외에 까다로운 제약사항이 하나 더 있습니다. 서브 도메인(subdomain)인 `forum.site.com`에서도 쿠키 정보를 얻을 수 없다는 점입니다.
```javascript
// site.com에서 쿠키를 설정함
document.cookie = "user=John"

// site.com의 서브도메인인 forum.site.com에서 user 쿠키에 접근하려 함
alert(document.cookie); // 찾을 수 없음
```

**서브 도메인이나 다른 도메인에서 쿠키에 접속할 방법은 없습니다. `site.com`에서 생성한 쿠키를 `other.com`에선 절대 전송받을 수 없습니다.**

이런 제약사항은 안정성을 높이기 위해 만들어졌습니다. 민감한 데이터가 저장된 쿠키는 관련 페이지에서만 볼 수 있도록 하기 위해서 말이죠.

그런데 정말 `forum.site.com`과 같은 서브 도메인에서 `site.com`에서 생성한 쿠키 정보를 얻을 방법이 없는 걸까요? 방법이 있습니다. `site.com`에서 쿠키를 설정할 때 `domain` 옵션에 루트 도메인인 `domain=site.com`을 명시적으로 설정해 주면 되죠.
```javascript
// site.com에서
// 서브 도메인(*.site.com) 어디서든 쿠키에 접속하게 설정할 수 있습니다.
document.cookie = "user=John; domain=site.com"

// 이렇게 설정하면

// forum.site.com와 같은 서브도메인에서도 쿠키 정보를 얻을 수 있습니다.
alert(document.cookie); // user=John 쿠키를 확인할 수 있습니다.
```

하위 호환성 유지를 위해 (`site.com` 앞에 점을 붙인) `domain=.site.com`도 `domain=site.com`과 동일하게 작동합니다. 오래된 표기법이긴 하지만 구식 브라우저를 지원하려면 이 표기법을 사용하는 것이 좋습니다.

이렇게 `domain` 옵션값을 적절히 사용하면 서브 도메인에서도 쿠키에 접근할 수 있습니다.

### `expires` · `max-age`
`expires`(유효 일자)나 `max-age`(만료 기간) 옵션이 지정되어있지 않으면, 브라우저가 닫힐 때 쿠키도 함께 삭제됩니다. 이런 쿠키를 "세션 쿠키(session cookie)"라고 부릅니다.

`expires` 나 `max-age` 옵션을 설정하면 브라우저를 닫아도 쿠키가 삭제되지 않습니다.

- `expires=Tue, 19 Jan 2038 03:14:07 GMT`

브라우저는 설정된 유효 일자까지 쿠키를 유지하다가, 해당 일자가 도달하면 쿠키를 자동 삭제합니다.

쿠키의 유효 일자는 반드시 GMT(Greenwich Mean Time) 포맷으로 설정해야 합니다. `date.toUTCString`을 사용하면 해당 포맷으로 쉽게 변경할 수 있습니다. 아래는 유효 기간이 하루인 쿠키를 만드는 예시입니다.
```javascript
// 지금으로부터 하루 후
let date = new Date(Date.now() + 86400e3);
date = date.toUTCString();
document.cookie = "user=John; expires=" + date;
```

`expires` 옵션값을 과거로 지정하면 쿠키는 삭제됩니다.

- `max-age=3600`

`max-age`는 `expires` 옵션의 대안으로, 쿠키 만료 기간을 설정할 수 있게 해줍니다. 현재부터 설정하고자 하는 만료일시까지의 시간을 초로 환산한 값을 설정합니다.

0이나 음수값을 설정하면 쿠키는 바로 삭제됩니다.

```javascript
// 1시간 뒤에 쿠키가 삭제됩니다.
document.cookie = "user=John; max-age=3600";

// 만료 기간을 0으로 지정하여 쿠키를 바로 삭제함
document.cookie = "user=John; max-age=0";
```

### `secure`
- `secure`

이 옵션을 설정하면 HTTPS로 통신하는 경우에만 쿠키가 전송됩니다.

**`secure` 옵션이 없으면 기본 설정이 적용되어 `http://site.com`에서 설정(생성)한 쿠키를 `https://site.com`에서 읽을 수 있고, `https://site.com`에서 설정(생성)한 쿠키도 `http://site.com`에서 읽을 수 있습니다.**

쿠키는 기본적으로 도메인만 확인하지 프로토콜을 따지진 않기 때문입니다.

하지만 `secure` 옵션이 설정된 경우, `https://site.com`에서 설정한 쿠키는 `http://site.com`에서 접근할 수 없습니다. 쿠키에 민감한 내용이 저장되어 있어 암호화되지 않은 HTTP 연결을 통해 전달되는 걸 원치 않는다면 이 옵션을 사용하면 됩니다.
```javascript
// (https:// 로 통신하고 있다고 가정 중)
// 설정한 쿠키는 HTTPS 통신시에만 접근할 수 있음
document.cookie = "user=John; secure";
```
