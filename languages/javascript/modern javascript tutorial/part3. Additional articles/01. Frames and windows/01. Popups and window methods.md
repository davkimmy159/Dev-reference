팝업 · `window` 메서드
=====================

##### 찹업창
- 추가 문서 표시 기능 <sub>(오래된 메서드)</sub>
- 인수 <sub>(url)</sub> 대상 새 창 표시
- 대다수 모던 브라우저
  - 새 탭 생성
  - 새 창 X 
```javascript
window.open('https://javascript.info/')
```

#### 팝업창
- 아주 오래전부터 존재

##### 최초 용도
 - 주 창 닫힘 없이 추가 콘텐츠 표시

##### 현재
- 다른 많은 대체재 有
  - 데이터 동적 로드 <sub>(`fetch` 등)</sub>
  - 동적 요소 <sub>(`<div>` 등)</sub>  생성 후 출력
- 팝업 사용량 ↓

##### 모바일 기기
- 까다로운 사용법
  - 동시 다수 창 표시 X

##### 현재까지도 팝업창 필요 작업 有
- ex\) OAuth
  - 로그인 <sub>(Google/… · Facebook/…)

##### 사용 이유

1. 분리된 별도 창 <sub>(고유 JS 환경 보유)</sub>
    - 신뢰할 수 없는 타 사이트 팝업창
      - 안전하게 열기 가능
2. 쉬운 사용법
3. 탐색 <sub>(url 변경)</sub> · 이전 창 메시지 보내기 가능

### 팝업 막기

##### 과거
- 악의적 사이트 팝업창 악용
  - ex\) 수많은 광고 표시 등

##### 대다수 브라우저
- 팝업창 방지 · 사용자 보호 노력
- 프로그램적 팝업창 열기 방지
  - 사용자 행동 · 이벤트 X
```javascript
// 팝업창 X
window.open('https://javascript.info');

// 팝업창 표시
button.onclick = () => {
  window.open('https://javascript.info');
};
```

##### 우회 방법 有
- `setTimeout` <sub>(함수)</sub> 사용
```javascript
// 3초 후 팝업창 표시
// - Chrome 작동
// - Firefox X
setTimeout(() => window.open('http://google.com'), 3000);
```
- 짤은 지연 시간 설정
…If we decrease the delay, the popup works in Firefox too:
```javascript
// 1초 후 팝업창 표시
// - Chrome 작동
// - Firefox 작동
setTimeout(() => window.open('http://google.com'), 1000);
```

##### 지연 시간 차이점 <sub>(Firefox)</sub>
- 2000ms 이하
  - 팝업창 허용
- 2000ms 이상
  - `isTrusted` <sub>(이벤트 프로퍼티)</sub>
    - `false` 설정

### [`window.open`](https://developer.mozilla.org/en-US/docs/Web/API/Window/open)

##### 문법 <sub>(팝업창 표시)</sub>
```javascript
window.open(url, name, params)
```

##### `url` <sub>(문자열)</sub>
- 새 창 표시 내용 주소

##### `name` <sub>(문자열)</sub>
- 새 창 이름
- 각 창 내 해당 프로퍼티 有
  - 팝업창 내 내용 출력할 창 선택 가능
- 특정 이름 해당 창
  - 존재 시
    - 해당 창 내 url 내용 로드
  - 부재 시
    - 새 창 표시

##### `params` <sub>(문자열)</sub>
- 팝업창 설정
- `,` <sub>(콤마)</sub> 구분
  - 공백 X
  - ex\) `width=200,height=100`

### `params` <sub>(팝업창 설정)</sub>

#### 위치

##### `left` · `top` <sub>(숫자)</sub>
- 화면 내 창 좌상단 모서리 좌표
- 화면 외부 위치 X

##### `width` · `height` <sub>(숫지)</sub>
- 창 너비 · 높이
- 최소 너비 · 높이 설정 X
  - 안 보이는 창 생성 X

#### 창 특성

##### `menubar` <sub>(`yes` · `no`)</sub>
- 브라우저 메뉴 표시 여부

##### `toolbar` <sub>(`yes` · `no`)</sub>
- 브라우저 탐색 바 표시 여부
  - 앞으로 이동
  - 뒤로 이동
  - 재로드
  - 기타 등등

##### `location` <sub>(`yes` · `no`)</sub>
- url 필드 표시 여부
- Firefox · IE
  - 숨기기 X

##### `status` <sub>(`yes` · `no`)</sub>
- 상태 바 표시 여부
- 대다수 브라우저
  - 강제 표시

##### `resizable` <sub>(`yes` · `no`)</sub>
- 창 크기 재설정 가능 여부
  - 권장 X

##### `scrollbars` <sub>(`yes` · `no`)</sub>
- 스크롤바 기능 설정 여부
  - 권장 X

##### 기타 설정
- 자주 사용 X
- 특정 브라우저 지원

### 깔끔한 창 예시

##### 최소 설정 창 열기
- 브라우저 비활성 허용 설정 확인
  - 대다수 창 특성 비활성화
  - 창 위치
    - 화면 외부
```javascript
let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,
width=0,height=0,left=-1000,top=-1000`;

open('/', 'test', params);
```

|설정|값|
|---|:---:|
|`scrollbars`|`no`|
|`resizable`|`no`|
|`status`|`no`|
|`location`|`no`|
|`toolbar`|`no`|
|`menubar`|`no`|
|`width`|`0`|
|`height`|`0`|
|`left`|`-1000`|
|`top`|`-1000`|

##### 브라우저 자동 교정 <sub>(부적절한 값)</sub>
- `0`
  - `width`
  - `height`
- 화면 외부 <sub>(음수)</sub>
  - `left`
  - `top`

##### Chrome
- 화면 크기 동일 창 표시 <sub>(full screen)</sub>

##### 정상적인 위치 값 설정
- 대다수 브라우저
  - 설정대로 창 표시
```javascript
let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,
width=600,height=300,left=100,top=100`;

open('/', 'test', params);
```

|설정|값|
|---|:---:|
|…|…|
|`width`|`600`|
|`height`|`300`|
|`left`|`100`|
|`top`|`100`|

#### 설정 생략 시 적용 규칙

##### 3번째 인수 생략 · 빈 객체 전달
- 기본값 사용

##### 일부 특성 `yes` · `no` 생략
- 해당 특성 `no` 설정
  - 필요 특성 `yes` 설정 필수

##### `left` · `top` 생략
- 마지막 열렸던 창 위치 근처에 새 창 열기 시도

##### `width` · `height` 생략
- 마지막 열렸던 창 동일 값 설정

### 팝업창 접근
The `open` call returns a reference to the new window. It can be used to manipulate it's properties, change location and even more.

In this example, we generate popup content from JavaScript:
```javascript
let newWin = window.open("about:blank", "hello", "width=200,height=200");

newWin.document.write("Hello, world!");
```

And here we modify the contents after loading:
```javascript
let newWindow = open('/', 'example', 'width=300,height=300')
newWindow.focus();

alert(newWindow.location.href); // (*) about:blank, loading hasn't started yet

newWindow.onload = function() {
  let html = `<div style="font-size:30px">Welcome!</div>`;
  newWindow.document.body.insertAdjacentHTML('afterbegin', html);
};
```

Please note: immediately after `window.open`, the new window isn't loaded yet. That's demonstrated by `alert` in line `(*)`. So we wait for `onload` to modify it. We could also use `DOMContentLoaded` handler for `newWin.document`.

<br />

<img src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **Same origin policy**

Windows may freely access content of each other only if they come from the same origin (the same protocol://domain:port).

Otherwise, e.g. if the main window is from `site.com`, and the popup from `gmail.com`, that's impossible for user safety reasons. For the details, see chapter Cross-window communication.

<br />

### Accessing window from popup
A popup may access the "opener" window as well using `window.opener` reference. It is `null` for all windows except popups.

If you run the code below, it replaces the opener (current) window content with "Test":
```javascript
let newWin = window.open("about:blank", "hello", "width=200,height=200");

newWin.document.write(
  "<script>window.opener.document.body.innerHTML = 'Test'<\/script>"
);
```

So the connection between the windows is bidirectional: the main window and the popup have a reference to each other.

### Closing a popup
To close a window: `win.close()`.

To check if a window is closed: `win.closed`.

Technically, the `close()` method is available for any `window`, but `window.close()` is ignored by most browsers if `window` is not created with `window.open()`. So it'll only work on a popup.

The `closed` property is `true` if the window is closed. That's useful to check if the popup (or the main window) is still open or not. A user can close it anytime, and our code should take that possibility into account.

This code loads and then closes the window:
```javascript
let newWindow = open('/', 'example', 'width=300,height=300');

newWindow.onload = function() {
  newWindow.close();
  alert(newWindow.closed); // true
};
```

### Scrolling and resizing
There are methods to move/resize a window:

- `win.moveBy(x,y)`
  - Move the window relative to current position `x` pixels to the right and `y` pixels down. Negative values are allowed (to move left/up).
- `win.moveTo(x,y)`
  - Move the window to coordinates `(x,y)` on the screen.
- `win.resizeBy(width,height)`
  - Resize the window by given `width`/`height` relative to the current size. Negative values are allowed.
- `win.resizeTo(width,height)`
  - Resize the window to the given size.

There's also `window.onresize` event.

<br />

<img src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **Only popups**

To prevent abuse, the browser usually blocks these methods. They only work reliably on popups that we opened, that have no additional tabs.

<br />

<img src="../../images/commons/icons/triangle-exclamation-solid.svg" /> **No minification/maximization**

JavaScript has no way to minify or maximize a window. These OS-level functions are hidden from Frontend-developers.

Move/resize methods do not work for maximized/minimized windows.

<br />

### Scrolling a window
We already talked about scrolling a window in the chapter 브라우저 창 사이즈와 스크롤.

- `win.scrollBy(x,y)`
  - Scroll the window `x` pixels right and `y` down relative the current scroll. Negative values are allowed.
- `win.scrollTo(x,y)`
  - Scroll the window to the given coordinates `(x,y)`.
- `elem.scrollIntoView(top = true)`
  - Scroll the window to make `elem` show up at the top (the default) or at the bottom for `elem.scrollIntoView(false)`.

There's also `window.onscroll` event.

### `Focus`/`blur` on a window
Theoretically, there are `window.focus()` and `window.blur()` methods to focus/unfocus on a window. And there are also `focus`/`blur` events that allow to catch the moment when the visitor focuses on a window and switches elsewhere.

Although, in practice they are severely limited, because in the past evil pages abused them.

For instance, look at this code:
```javascript
window.onblur = () => window.focus();
```

When a user attempts to switch out of the window (`window.onblur`), it brings the window back into focus. The intention is to "lock" the user within the `window`.

So browsers had to introduce many limitations to forbid the code like that and protect the user from ads and evils pages. They depend on the browser.

For instance, a mobile browser usually ignores `window.focus()` completely. Also focusing doesn't work when a popup opens in a separate tab rather than a new window.

Still, there are some use cases when such calls do work and can be useful.

For instance:
- When we open a popup, it's might be a good idea to run a `newWindow.focus() `on it. Just in case, for some OS/browser combinations it ensures that the user is in the new window now.
- If we want to track when a visitor actually uses our web-app, we can track `window.onfocus`/`onblur`. That allows us to suspend/resume in-page activities, animations etc. But please note that the `blur` event means that the visitor switched out from the window, but they still may observe it. The window is in the background, but still may be visible.

<br />

## 요약
Popup windows are used rarely, as there are alternatives: loading and displaying information in-page, or in iframe.

If we're going to open a popup, a good practice is to inform the user about it. An "opening window" icon near a link or button would allow the visitor to survive the focus shift and keep both windows in mind.
- A popup can be opened by the `open(url, name, params)` call. It returns the reference to the newly opened window.
- Browsers block `open` calls from the code outside of user actions. Usually a notification appears, so that a user may allow them.
- Browsers open a new tab by default, but if sizes are provided, then it'll be a popup window.
- The popup may access the opener window using the `window.opener` property.
- The main window and the popup can freely read and modify each other if they have the same origin. Otherwise, they can change location of each other and exchange messages.

To close the popup: use `close()` call. Also the user may close them (just like any other windows). The `window.closed` is `true` after that.
- Methods `focus()` and `blur()` allow to focus/unfocus a window. But they don't work all the time.
- Events `focus` and `blur` allow to track switching in and out of the window. But please note that a window may still be visible even in the background state, after `blur`.
